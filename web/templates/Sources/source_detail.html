{% extends "base.html" %}

{% block title %}{{ _('Source Details') }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item">
    <a href="{{ url_for('index') }}">
        <i class="bi bi-house-door me-1"></i>{{ _('Home') }}
    </a>
</li>
<li class="breadcrumb-item">
    <a href="{{ url_for('sources_list') }}">
        <i class="bi bi-building me-1"></i>{{ _('Sources') }}
    </a>
</li>
<li class="breadcrumb-item active" aria-current="page">
    {{ source.name if source else _('Source Details') }}
</li>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="bi bi-building me-2"></i>
        {{ _('Source Details') }}
    </h1>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="stat-card">
            <h5 class="mb-3">{{ _('Source Information') }}</h5>
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <div class="h4 text-primary mb-0">{{ source.doc_count|default(0) }}</div>
                        <small class="text-muted">{{ _('Documents') }}</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <div class="h4 text-success mb-0">{{ source.file_types|default(0) }}</div>
                        <small class="text-muted">{{ _('File Types') }}</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <div class="h4 text-warning mb-0">
                            {% if source.total_size %}
                                {% if source.total_size > 1073741824 %}
                                    {{ (source.total_size / 1073741824)|round(1) }} {{ _('GB') }}
                                {% else %}
                                    {{ (source.total_size / 1048576)|round(1) }} {{ _('MB') }}
                                {% endif %}
                            {% else %}
                                0 {{ _('MB') }}
                            {% endif %}
                        </div>
                        <small class="text-muted">{{ _('Total Size') }}</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <div class="h4 text-info mb-0">{{ (source.importance * 100)|round|int }}%</div>
                        <small class="text-muted">{{ _('Importance') }}</small>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">{{ _('Source Name') }}</label>
                        <p class="form-control-plaintext"><strong>{{ source.name }}</strong></p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">{{ _('Job/Type') }}</label>
                        <p class="form-control-plaintext">{{ source.job }}</p>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">{{ _('Country') }}</label>
                        <p class="form-control-plaintext">{{ source.country }}</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">{{ _('City') }}</label>
                        <p class="form-control-plaintext">{{ source.city or 'N/A' }}</p>
                    </div>
                </div>
            </div>
            {% if source.description %}
            <div class="mb-3">
                <label class="form-label">{{ _('Description') }}    </label>
                <p class="form-control-plaintext">{{ source.description }}</p>
            </div>
            {% endif %}
            {% if source.accounts %}
            <div class="mb-3">
                <label class="form-label">{{ _('Social Media Accounts') }}</label>
                <p class="form-control-plaintext">{{ source.accounts }}</p>
            </div>
            {% endif %}
            {% if source.attachments %}
            <div class="mb-3">
                <label class="form-label">{{ _('Attachments') }}</label>
                <p class="form-control-plaintext">{{ source.attachments }}</p>
            </div>
            {% endif %}
            {% if source.note %}
            <div class="mb-3">
                <label class="form-label">{{ _('Notes') }}</label>
                <p class="form-control-plaintext">{{ source.note }}</p>
            </div>
            {% endif %}
            {% if source.date_creation %}
            <div class="mb-3">
                <label class="form-label">{{ _('Created') }}</label>
                <p class="form-control-plaintext">{{ source.date_creation.strftime('%Y-%m-%d %H:%M') }}</p>
            </div>
            {% endif %}
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">{{ _('Ownership') }}</label>
                        <p class="form-control-plaintext">{{ source.ownership or 'N/A' }}</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">{{ _('Access Status') }}</label>
                        <p class="form-control-plaintext">{{ source.access_status or 'N/A' }}</p>
                    </div>
                </div>
            </div>
            {% if source.date_source_discovery %}
            <div class="mb-3">
                <label class="form-label">{{ _('Date of Source Discovery') }}</label>
                <p class="form-control-plaintext">{{ source.date_source_discovery.strftime('%Y-%m-%d') }}</p>
            </div>
            {% endif %}
            {% if source.category_name %}
            <div class="mb-3">
                <label class="form-label">{{ _('Category') }}</label>
                <p class="form-control-plaintext">{{ source.category_name }}</p>
            </div>
            {% endif %}
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card">
            <h5 class="mb-3">{{ _('Actions') }}</h5>
            <div class="d-grid gap-2">
                <a href="{{ url_for('sources_list') }}?edit={{ source.id }}" class="btn btn-success">
                    <i class="bi bi-pencil me-2"></i>{{ _('Edit Source') }}
                </a>
       <!--         <button class="btn btn-outline-danger" onclick='deleteSource({{ source.id }}, {{ source.name|tojson }})'>
                    <i class="bi bi-trash me-2"></i>{{ _('Delete Source') }}
                </button> -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Translations for JavaScript
const translations = {
    deleteSourceConfirm: {{ _('Are you sure you want to delete this source?')|tojson }},
    sourceDeletedSuccessfully: {{ _('Source deleted successfully!')|tojson }},
    error: {{ _('Error')|tojson }}
};

// âœ… SECURITY: Helper function to get CSRF token
function getCSRFToken() {
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    return metaTag ? metaTag.getAttribute('content') : '';
}

function deleteSource(id, sourceName = '') {
    const confirmMessage = sourceName 
        ? `Are you sure you want to delete the source "${sourceName}"?\n\nThis action cannot be undone.`
        : translations.deleteSourceConfirm;
    
    if (confirm(confirmMessage)) {
        // Show processing notification
        if (window.MessageFormatter) {
            window.MessageFormatter.showNotification('delete', 'processing', { item: sourceName || 'Source' });
        }
        
        fetch(`/api/sources/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Show formatted success notification
                    if (window.MessageFormatter) {
                        window.MessageFormatter.showDeleteSuccess(sourceName || 'Source', {
                            title: 'Source Deleted',
                            duration: 4000
                        });
                    } else {
                        alert(translations.sourceDeletedSuccessfully);
                    }
                    setTimeout(() => {
                        window.location.href = "{{ url_for('sources_list') }}";
                    }, 500);
                } else {
                    // Show formatted error notification
                    if (window.MessageFormatter) {
                        window.MessageFormatter.showDeleteError(sourceName || 'Source', {
                            title: 'Delete Failed',
                            duration: 6000
                        });
                    } else {
                        alert(translations.error + ': ' + data.error);
                    }
                }
            })
            .catch(e => {
                if (window.MessageFormatter) {
                    window.MessageFormatter.showDeleteError(sourceName || 'Source', {
                        title: 'Delete Error',
                        duration: 6000
                    });
                } else {
                    alert(translations.error + ': ' + e.message);
                }
            });
    }
}
</script>
{% endblock %}

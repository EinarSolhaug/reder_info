{% extends "base.html" %}

{% block title %}{{ _('Side Details') }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="bi bi-diagram-3 me-2"></i>
        {{ _('Side Details') }}
    </h1>
    <a href="{{ url_for('sides_list') }}" class="btn btn-outline-primary">
        <i class="bi bi-arrow-left me-2"></i>
        {{ _('Back to Sides') }}
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="stat-card">
            <h5 class="mb-3">{{ _('Side Information') }}</h5>
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <div class="h4 text-primary mb-0">{{ side.doc_count|default(0) }}</div>
                        <small class="text-muted">{{ _('Documents') }}</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <div class="h4 text-success mb-0">{{ side.source_count|default(0) }}</div>
                        <small class="text-muted">{{ _('Sources') }}</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <div class="h4 text-warning mb-0">
                            {% if side.total_size %}
                                {% if side.total_size > 1073741824 %}
                                    {{ (side.total_size / 1073741824)|round(1) }} {{ _('GB') }}
                                {% else %}
                                    {{ (side.total_size / 1048576)|round(1) }} {{ _('MB') }}
                                {% endif %}
                            {% else %}
                                0 {{ _('MB') }}
                            {% endif %}
                        </div>
                        <small class="text-muted">{{ _('Total Size') }}</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <div class="h4 text-info mb-0">{{ (side.importance * 100)|round|int }}%</div>
                        <small class="text-muted">{{ _('Importance') }}</small>
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">{{ _('Side Name') }}</label>
                <p class="form-control-plaintext"><strong>{{ side.name }}</strong></p>
            </div>
            {% if side.date_creation %}
            <div class="mb-3">
                <label class="form-label">{{ _('Created') }}</label>
                <p class="form-control-plaintext text-muted">{{ side.date_creation.strftime('%Y-%m-%d %H:%M') }}</p>
            </div>
            {% endif %}
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card">
            <h5 class="mb-3">{{ _('Actions') }}</h5>
            <div class="d-grid gap-2">
                <a href="{{ url_for('sides_list') }}?edit={{ side.id }}" class="btn btn-success">
                    <i class="bi bi-pencil me-2"></i>{{ _('Edit Side') }}
                </a>
        <!--        <button class="btn btn-outline-danger" onclick='deleteSide({{ side.id }}, {{ side.name|tojson }})'>
                    <i class="bi bi-trash me-2"></i>{{ _('Delete Side') }}
                </button> -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Translations for JavaScript
const translations = {
    deleteSideConfirm: {{ _('Are you sure you want to delete this side?')|tojson }},
    sideDeletedSuccessfully: {{ _('Side deleted successfully!')|tojson }},
    error: {{ _('Error')|tojson }}
};

// âœ… SECURITY: Helper function to get CSRF token
function getCSRFToken() {
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    return metaTag ? metaTag.getAttribute('content') : '';
}

function deleteSide(id, sideName = '') {
    const confirmMessage = sideName 
        ? `Are you sure you want to delete the side "${sideName}"?\n\nThis action cannot be undone.`
        : translations.deleteSideConfirm;
    
    if (confirm(confirmMessage)) {
        // Show processing notification
        if (window.MessageFormatter) {
            window.MessageFormatter.showNotification('delete', 'processing', { item: sideName || 'Side' });
        }
        
        fetch(`/api/sides/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Show formatted success notification
                    if (window.MessageFormatter) {
                        window.MessageFormatter.showDeleteSuccess(sideName || 'Side', {
                            title: 'Side Deleted',
                            duration: 4000
                        });
                    } else {
                        alert(translations.sideDeletedSuccessfully);
                    }
                    setTimeout(() => {
                        window.location.href = "{{ url_for('sides_list') }}";
                    }, 500);
                } else {
                    // Show formatted error notification
                    if (window.MessageFormatter) {
                        window.MessageFormatter.showDeleteError(sideName || 'Side', {
                            title: 'Delete Failed',
                            duration: 6000
                        });
                    } else {
                        alert(translations.error + ': ' + data.error);
                    }
                }
            })
            .catch(e => {
                if (window.MessageFormatter) {
                    window.MessageFormatter.showDeleteError(sideName || 'Side', {
                        title: 'Delete Error',
                        duration: 6000
                    });
                } else {
                    alert(translations.error + ': ' + e.message);
                }
            });
    }
}
</script>
{% endblock %}

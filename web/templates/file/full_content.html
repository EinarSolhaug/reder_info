{% extends "base.html" %}

{% block title %}{{ file[1] }} - {{ _('Reader') }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <h1 class="h3 mb-2"><i class="bi bi-journal-text me-2"></i>{{ file[1] }} - {{ _('Reader') }}</h1>
            <div class="text-muted small d-flex gap-3">
                <span><i class="bi bi-hdd me-1"></i>{{ ((file[3] or 0) / 1024)|round(1) }} KB</span>
                <span><i class="bi bi-calendar me-1"></i>{{ file[7].strftime('%Y-%m-%d') if file[7] else 'N/A' }}</span>
                <span><i class="bi bi-hash me-1"></i>{{ _('ID') }} {{ file[0] }}</span>
            </div>
        </div>
        <div class="btn-toolbar gap-2" role="toolbar" aria-label="{{ _('Toolbar') }}">
            <a href="/file/{{ file[0] }}" class="btn btn-outline-primary"><i class="bi bi-arrow-left me-1"></i>{{ _('Details') }}</a>
            <button class="btn btn-outline-secondary" id="btnCopy"><i class="bi bi-clipboard me-1"></i>{{ _('Copy') }}</button>
            <button class="btn btn-outline-secondary" id="btnDownload"><i class="bi bi-download me-1"></i>{{ _('Download') }}</button>
            <button class="btn btn-outline-secondary" id="btnPrint"><i class="bi bi-printer me-1"></i>{{ _('Print') }}</button>
            <div class="vr d-none d-md-block"></div>
            <button class="btn btn-outline-secondary" id="btnWrap"><i class="bi bi-text-wrap me-1"></i>{{ _('Wrap') }}</button>
            <button class="btn btn-outline-secondary" id="btnFontDec" title="{{ _('Smaller') }}"><i class="bi bi-zoom-out"></i></button>
            <button class="btn btn-outline-secondary" id="btnFontInc" title="{{ _('Larger') }}"><i class="bi bi-zoom-in"></i></button>
            <button class="btn btn-outline-dark" id="btnTheme"><i class="bi bi-moon me-1"></i>{{ _('Dark') }}</button>
        </div>
    </div>

    {% if content_stats %}
    <div class="row g-3 mb-3">
        <div class="col-6 col-md-3">
            <div class="card h-100"><div class="card-body text-center"><div class="h5 mb-0">{{ content_stats.estimated_words|default(0) }}</div><div class="text-muted small">{{ _('Words') }}</div></div></div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card h-100"><div class="card-body text-center"><div class="h5 mb-0">{{ (content_stats.total_size or 0) }}</div><div class="text-muted small">{{ _('Bytes Stored') }}</div></div></div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card h-100"><div class="card-body text-center"><div class="h5 mb-0">{{ content_stats.chunks|default(0) }}</div><div class="text-muted small">{{ _('Chunks') }}</div></div></div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card h-100"><div class="card-body text-center"><div class="h5 mb-0">{{ total_chars or 0 }}</div><div class="text-muted small">{{ _('Characters') }}</div></div></div>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary">{{ start_char or 1 }}–{{ end_char or (content|length if content) }} {{ _('of') }} {{ total_chars or 0 }}</span>
                <div class="d-none d-md-flex align-items-center gap-2">
                    <i class="bi bi-arrows-move"></i>
                    <input type="range" min="0" max="{{ total_chars or 0 }}" value="{{ start_char or 1 }}" class="form-range" id="rangeJump" style="width: 220px;">
                </div>
            </div>
            <div class="input-group" style="max-width:520px;">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" id="q" class="form-control" placeholder="{{ _('Search... (supports whole word, case)') }}" value="{{ search_query }}">
                <button class="btn btn-outline-secondary" id="btnPrev"><i class="bi bi-arrow-up"></i></button>
                <button class="btn btn-outline-secondary" id="btnNext"><i class="bi bi-arrow-down"></i></button>
                <button class="btn btn-outline-secondary" id="btnClear"><i class="bi bi-x-lg"></i></button>
                <div class="input-group-text gap-2">
                    <label class="small m-0"><input class="form-check-input me-1" type="checkbox" id="optCase" {% if case_sensitive %}checked{% endif %}>{{ _('Aa') }}</label>
                    <label class="small m-0"><input class="form-check-input me-1" type="checkbox" id="optWhole" {% if whole_word %}checked{% endif %}>{{ _('Whole') }}</label>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div id="reader" class="reader">
                <pre id="content" class="content pre-wrap"></pre>
                <div id="sentinel" class="sentinel text-center text-muted py-3">{{ _('Loading…') }}</div>
            </div>
        </div>
        <div class="card-footer d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="small text-muted" id="status">{{ _('Ready') }}</div>
            <div class="d-flex align-items-center gap-2">
                <label class="small text-muted">{{ _('Chunk size') }} </label>
                <select id="chunkSize" class="form-select form-select-sm" style="width:auto;">
                    <option value="20000">20k</option>
                    <option value="50000" selected>50k</option>
                    <option value="100000">100k</option>
                </select>
                <button class="btn btn-sm btn-outline-primary" id="btnTop"><i class="bi bi-chevron-double-up"></i></button>
                <button class="btn btn-sm btn-outline-primary" id="btnBottom"><i class="bi bi-chevron-double-down"></i></button>
            </div>
        </div>
    </div>
</div>

<style>
.reader { max-height: 78vh; overflow: auto; background: var(--reader-bg,#0); }
.content { margin: 0; padding: 1rem 1.25rem; font-family: 'Courier New', monospace; line-height: 1.6; font-size: 14px; color: var(--reader-fg,#212529); }
.pre-wrap { white-space: pre-wrap; word-break: break-word; }
.pre { white-space: pre; }
.hl { background: var(--warning-color); padding: 0 2px; border-radius: 2px; opacity: 0.7; }
.hl.current { background: var(--warning-color); outline: 2px solid var(--btn-warning); }
.dark .reader { background: var(--bg-dark); }
.dark .content { color: var(--text-white); }
.sentinel { border-top: 1px solid var(--border-light); }
</style>

<script>
// --- State ---
const fileId = {{ file[0] }};
let totalChars = {{ total_chars or 0 }};
let buffer = []; // array of { offset, data }
let fetching = false;
let eof = false;
let wrap = true;
let fontPx = 14;
let themeDark = false;

// DOM
const elReader = document.getElementById('reader');
const elContent = document.getElementById('content');
const elSentinel = document.getElementById('sentinel');
const elStatus = document.getElementById('status');
const elQ = document.getElementById('q');
const elPrev = document.getElementById('btnPrev');
const elNext = document.getElementById('btnNext');
const elClear = document.getElementById('btnClear');
const elWrap = document.getElementById('btnWrap');
const elCopy = document.getElementById('btnCopy');
const elDownload = document.getElementById('btnDownload');
const elPrint = document.getElementById('btnPrint');
const elFontInc = document.getElementById('btnFontInc');
const elFontDec = document.getElementById('btnFontDec');
const elTheme = document.getElementById('btnTheme');
const elRange = document.getElementById('rangeJump');
const elChunkSize = document.getElementById('chunkSize');
const optCase = document.getElementById('optCase');
const optWhole = document.getElementById('optWhole');

// --- Utilities ---
const escapeHtml = t => t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
function setStatus(s){ elStatus.textContent=s; }

// --- Rendering ---
function renderBuffer(){
  buffer.sort((a,b)=>a.offset-b.offset);
  const text = buffer.map(c=>c.data).join('');
  elContent.innerHTML = escapeHtml(text);
  applyHighlights();
}

// --- Fetching ---
async function fetchChunk(offset, limit){
  const url = new URL(window.location.origin + `/file/${fileId}/content`);
  url.searchParams.set('offset', offset);
  url.searchParams.set('limit', limit);
  const res = await fetch(url, { headers: { 'Accept':'application/json' } });
  if(!res.ok) throw new Error('Fetch failed');
  return res.json();
}

async function ensureNext(){
  if(fetching || eof) return;
  fetching = true;
  const limit = parseInt(elChunkSize.value || '50000', 10);
  const nextOffset = buffer.length ? buffer[buffer.length-1].offset + buffer[buffer.length-1].data.length : 0;
  if(totalChars && nextOffset>=totalChars){ eof=true; setStatus('All loaded'); fetching=false; return; }
  try{
    setStatus(`Loading ${nextOffset}…`);
    const j = await fetchChunk(nextOffset, limit);
    buffer.push({ offset: j.offset, data: j.content || '' });
    totalChars = j.total_length || totalChars;
    if(!j.has_more) { eof = true; }
    renderBuffer();
    setStatus(`Loaded ${Math.min(nextOffset+ (j.content?j.content.length:0), totalChars)} / ${totalChars}`);
  }catch(e){ setStatus('Error loading'); console.error(e); }
  finally{ fetching=false; }
}

// Infinite scroll via IntersectionObserver
const io = new IntersectionObserver((entries)=>{
  for(const e of entries){ if(e.isIntersecting){ ensureNext(); } }
},{ root: elReader, threshold: 0.1 });
io.observe(elSentinel);

// Initial load: show server-provided first page if any
(function bootstrapInitial(){
  const initial = `{{ (content or '')|replace('\\','\\\\')|replace('\n','\\n')|replace('\r','\\r')|replace('`','\\`') }}`;
  const start = {{ (start_char or 1) - 1 }};
  if(initial && initial.length){ buffer.push({ offset: start, data: initial }); renderBuffer(); }
  if(!initial || initial.length < (parseInt(elChunkSize.value,10)||50000)){ ensureNext(); }
})();

// --- Search ---
let matchPositions = []; let currentMatch = -1;
function buildRegex(q){ if(!q) return null; const w = optWhole.checked? `\\b${q}\\b` : q; return new RegExp(w, optCase.checked? 'g':'gi'); }
function computeMatches(){
  const text = elContent.textContent || '';
  const rx = buildRegex(elQ.value.trim());
  matchPositions = [];
  if(!rx) return;
  let m; while((m = rx.exec(text))!==null){ matchPositions.push({ start:m.index, end:m.index+m[0].length }); if(m[0].length===0) rx.lastIndex++; }
}
function applyHighlights(){
  const q = elQ.value.trim();
  if(!q){ return; }
  computeMatches();
  if(matchPositions.length===0){ return; }
  const text = elContent.textContent;
  let out = ''; let last = 0; matchPositions.forEach((p,i)=>{ out += escapeHtml(text.slice(last,p.start)); out += `<span class=\"hl${i===currentMatch?' current':''}\">`+escapeHtml(text.slice(p.start,p.end))+`</span>`; last=p.end; });
  out += escapeHtml(text.slice(last));
  elContent.innerHTML = out;
}
function gotoMatch(idx){ if(matchPositions.length===0) return; currentMatch = (idx+matchPositions.length)%matchPositions.length; applyHighlights(); const spans = elContent.querySelectorAll('.hl'); if(spans[currentMatch]) spans[currentMatch].scrollIntoView({behavior:'smooth', block:'center'}); setStatus(`Match ${currentMatch+1}/${matchPositions.length}`); }

elQ.addEventListener('keydown',e=>{ if(e.key==='Enter'){ currentMatch=-1; computeMatches(); gotoMatch(0); } });
elNext.addEventListener('click',()=> gotoMatch(currentMatch+1));
elPrev.addEventListener('click',()=> gotoMatch(currentMatch-1));
elClear.addEventListener('click',()=>{ elQ.value=''; currentMatch=-1; matchPositions=[]; setStatus('Search cleared'); renderBuffer(); });
optCase.addEventListener('change',()=>{ currentMatch=-1; renderBuffer(); });
optWhole.addEventListener('change',()=>{ currentMatch=-1; renderBuffer(); });

// --- Controls ---
elWrap.addEventListener('click',()=>{ wrap=!wrap; elContent.classList.toggle('pre-wrap', wrap); elContent.classList.toggle('pre', !wrap); });
elFontInc.addEventListener('click',()=>{ fontPx=Math.min(24,fontPx+1); elContent.style.fontSize=fontPx+'px'; });
elFontDec.addEventListener('click',()=>{ fontPx=Math.max(10,fontPx-1); elContent.style.fontSize=fontPx+'px'; });
elTheme.addEventListener('click',()=>{ themeDark=!themeDark; document.body.classList.toggle('dark', themeDark); elTheme.innerHTML = themeDark? '<i class="bi bi-brightness-high me-1"></i>Light' : '<i class="bi bi-moon me-1"></i>Dark'; });
document.getElementById('btnTop').addEventListener('click',()=> elReader.scrollTo({top:0,behavior:'smooth'}));
document.getElementById('btnBottom').addEventListener('click',()=> elReader.scrollTo({top:elReader.scrollHeight,behavior:'smooth'}));
if(elRange){ elRange.addEventListener('input', async (e)=>{ const target = parseInt(e.target.value||'0',10); buffer = []; eof=false; fetching=false; setStatus('Jumping…'); elContent.innerHTML=''; const j = await fetchChunk(target, parseInt(elChunkSize.value,10)||50000); buffer.push({ offset: j.offset, data: j.content||'' }); totalChars=j.total_length||totalChars; eof=!j.has_more; renderBuffer(); elReader.scrollTop = 0; }); }

// Copy/Download/Print
elCopy.addEventListener('click', async ()=>{
  setStatus('Fetching all for copy…');
  await fetchAll();
  navigator.clipboard.writeText(elContent.textContent||'');
  setStatus('Copied to clipboard');
});
elDownload.addEventListener('click', async ()=>{
  setStatus('Preparing download…');
  const text = await getFullText();
  const blob = new Blob([text], {type:'text/plain'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download = `${encodeURIComponent(`{{ file[1] }}`)}.txt`; document.body.appendChild(a); a.click(); a.remove(); setStatus('Download started');
});
elPrint.addEventListener('click', async ()=>{
  const text = await getFullText();
  const w = window.open('', '_blank');
  if(!w) return; w.document.write(`<pre style="white-space:pre-wrap;font-family:monospace;">${escapeHtml(text)}</pre>`); w.document.close(); w.focus(); w.print();
});

async function fetchAll(){
  const limit = 100000;
  let offset = 0; const parts=[];
  while(!totalChars || offset < totalChars){
    const j = await fetchChunk(offset, limit);
    parts.push(j.content||'');
    offset += (j.content? j.content.length : 0);
    totalChars = j.total_length || totalChars;
    if(!j.has_more) break;
  }
  buffer = [{ offset: 0, data: parts.join('') }]; eof=true; renderBuffer();
}
async function getFullText(){
  if(!eof){ await fetchAll(); }
  return elContent.textContent||'';
}
</script>
{% endblock %}



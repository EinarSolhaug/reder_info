{% extends "base.html" %}

{% block title %}{{ _('File Library') }}{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/file-manger.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title"><i class="bi bi-book me-2"></i> {{ _('File Library') }} ({{ total_files|default(0)  }})</h1>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('files.upload_page') }}" class="btn btn-outline-primary"><i class="bi bi-plus-circle"></i>{{ _('Upload Files') }}</a>
        <button class="btn btn-outline-primary" onclick="location.reload()"><i class="bi bi-arrow-clockwise"></i>{{ _('Refresh') }}</button>
    </div>
</div>


<div class="file-management-container">

    <!-- Statistics Cards -->
    <div class="file-stats-grid">
        <div class="stat-card stat-card-total">
            <div class="stat-card-icon">
                <i class="bi bi-folder2-open"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-label">{{ _('Total Files') }}</div>
                <div class="stat-card-value" id="totalFiles">{{ total_files|default(0) }}</div>
            </div>
        </div>
        <div class="stat-card stat-card-analyzed">
            <div class="stat-card-icon">
                <i class="bi bi-check-circle"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-label">{{ _('Analyzed') }}</div>
                <div class="stat-card-value" id="analyzedCount">{{ total_analyzed|default(0) }}</div>
            </div>
        </div>
        <div class="stat-card stat-card-pending">
            <div class="stat-card-icon">
                <i class="bi bi-hourglass-split"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-label">{{ _('Pending') }}</div>
                <div class="stat-card-value" id="pendingCount">{{ total_pending|default(0) }}</div>
            </div>
        </div>
        <div class="stat-card stat-card-selected">
            <div class="stat-card-icon">
                <i class="bi bi-check-square"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-label">{{ _('Selected') }}</div>
                <div class="stat-card-value" id="selectedCount">0</div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="file-filters-section">
        <!-- Search and Main Filters -->
        <div class="filter-controls-grid">
            <div class="filter-group filter-group-search">
                <label for="smartSearch" class="filter-label">
                    <i class="bi bi-search"></i>
                    {{ _('Search Files') }}
                </label>
                <div class="search-input-wrapper">
                    <input type="text" 
                           id="smartSearch" 
                           class="form-control search-input" 
                           placeholder="{{ _('Search by name, content...') }}" 
                           value="{{ search }}"
                           autocomplete="off">
                    <button class="btn-clear-search" onclick="clearFileSearch()" title="{{ _('Clear search') }}">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>

            <div class="filter-group">
                <label for="sourceFilter" class="filter-label">
                    <i class="bi bi-building"></i>
                    {{ _('Source') }}
                </label>
                <select id="sourceFilter" class="form-select">
                    <option value="">{{ _('All Sources') }}</option>
                    {% for sid, sname in sources.items() %}
                    <option value="{{ sid }}" {% if source_filter == sid|string %}selected{% endif %}>
                        {{ sname }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="sideFilter" class="filter-label">
                    <i class="bi bi-diagram-3"></i>
                    {{ _('Side') }}
                </label>
                <select id="sideFilter" class="form-select">
                    <option value="">{{ _('All Sides') }}</option>
                    {% for sid, sname in sides.items() %}
                    <option value="{{ sid }}" {% if side_filter == sid|string %}selected{% endif %}>
                        {{ sname }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="fileTypeFilter" class="filter-label">
                    <i class="bi bi-file-earmark"></i>
                    {{ _('File Type') }}
                </label>
                <select id="fileTypeFilter" class="form-select">
                    <option value="">{{ _('All Types') }}</option>
                    {% if file_types %}
                        {% for ft_key, ft_value in file_types.items() %}
                        <option value="{{ ft_key }}" {% if file_type_filter == ft_key %}selected{% endif %}>
                            {{ ft_value }}
                        </option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>

            <div class="filter-group">
                <label for="statusFilter" class="filter-label">
                    <i class="bi bi-check-circle"></i>
                    {{ _('Status') }}
                </label>
                <select id="statusFilter" class="form-select">
                    <option value="">{{ _('All Status') }}</option>
                    <option value="Read" {% if status_filter == 'Read' %}selected{% endif %}>{{ _('Analyzed') }}</option>
                    <option value="Unread" {% if status_filter == 'Unread' %}selected{% endif %}>{{ _('Pending') }}</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="sortBy" class="filter-label">
                    <i class="bi bi-sort-alpha-down"></i>
                    {{ _('Sort By') }}
                </label>
                <select id="sortBy" class="form-select">
                    <option value="date_desc">{{ _('Newest First') }}</option>
                    <option value="date_asc">{{ _('Oldest First') }}</option>
                    <option value="name_asc">{{ _('Name (A-Z)') }}</option>
                    <option value="name_desc">{{ _('Name (Z-A)') }}</option>
                    <option value="size_desc">{{ _('Largest First') }}</option>
                    <option value="size_asc">{{ _('Smallest First') }}</option>
                </select>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
            <div class="action-group">
                <span class="action-label">{{ _('Selection:') }}</span>
                <button class="btn-action" onclick="selectAllFiles()">
                    <i class="bi bi-check-square"></i>
                    {{ _('Select All') }}
                </button>
                <button class="btn-action" onclick="deselectAllFiles()">
                    <i class="bi bi-square"></i>
                    {{ _('Select None') }}
                </button>
            </div>
            <div class="action-group">
                <span class="action-label">{{ _('Bulk Actions:') }}</span>
                <button class="btn-action btn-primary" id="bulkAnalyzeBtn" onclick="bulkAnalyze()" disabled>
                    <i class="bi bi-lightning-charge"></i>
                    {{ _('Analyze') }}
                </button>
                <button class="btn-action btn-outline-primary" id="bulkExportBtn" onclick="bulkExport()" disabled>
                    <i class="bi bi-download"></i>
                    {{ _('Export') }}
                </button>
      <!--          <button class="btn-action btn-outline-danger" id="bulkDeleteBtn" onclick="bulkDelete()" disabled>
                    <i class="bi bi-trash"></i>
                    {{ _('Delete') }}
                </button> -->
            </div>
            <div class="action-group">
                <span class="action-label">{{ _('View:') }}</span>
                <div class="view-mode-toggle">
                    <button class="view-mode-btn active" data-view="list" title="{{ _('List View') }}">
                        <i class="bi bi-list-ul"></i>
                    </button>
                    <button class="view-mode-btn" data-view="grid" title="{{ _('Grid View') }}">
                        <i class="bi bi-grid-3x3"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Info and Per Page -->
    <div class="results-info-bar">
        <div class="results-info" id="filesResultsInfo">
            {% if files and files|length > 0 %}
                {% set start = start_position|default(1) %}
                {% set end = start + files|length - 1 %}
                {{ _('Showing records') }} {{ start }}–{{ end }} {{ _('of') }} {{ total_files|default(0) }} {{ _('files') }}
            {% else %}
                {{ _('No files found') }}
            {% endif %}
        </div>
        <div class="d-flex align-items-center">
            <label for="perPageFiles" class="form-label me-2 mb-0">{{ _('Per Page:') }}</label>
            <select id="perPageFiles" class="form-select form-select-sm" style="width: auto;" onchange="changeFilesPageSize()">
                {% set current_limit = request.args.get('limit', '10') %}
                <option value="10" {% if current_limit == '10' %}selected{% endif %}>10</option>
                <option value="25" {% if current_limit == '25' %}selected{% endif %}>25</option>
                <option value="50" {% if current_limit == '50' %}selected{% endif %}>50</option>
                <option value="100" {% if current_limit == '100' %}selected{% endif %}>100</option>
            </select>
        </div>
    </div>

    <!-- Files Display Container -->
    <div class="files-display-container">
        <!-- List View (Default) -->
        <div class="files-view files-view-list active" data-view="list">
            <div class="table-wrapper">
                <table class="files-table" id="filesTable">
                    <thead>
                        <tr>
                            <th class="col-checkbox">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)">
                            </th>
                            <th class="col-number">#</th>
                            <th class="col-name">{{ _('File Name') }}</th>
                            <th class="col-type">{{ _('Type') }}</th>
                            <th class="col-size">{{ _('Size') }}</th>
                            <th class="col-source">{{ _('Source') }}</th>
                            <th class="col-side">{{ _('Side') }}</th>
                            <th class="col-status">{{ _('Status') }}</th>
                            <th class="col-date">{{ _('Date') }}</th>
                            <th class="col-actions">{{ _('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody id="filesTableBody">
                        {% for file in files %}
                        {% set row_number = (start_position|default(1)) + loop.index0 %}
                        <tr class="file-row" 
                            data-file-id="{{ file[0] }}" 
                            data-size="{{ file[3] }}" 
                            data-type="{{ file[4] }}"
                            data-status="{{ file[5] }}"
                            data-date="{{ file[7].isoformat() if file[7] else '' }}">
                            <td class="col-checkbox">
                                <input type="checkbox" 
                                       class="file-checkbox" 
                                       value="{{ file[0] }}" 
                                       onchange="updateBulkToolbar()">
                            </td>
                            <td class="col-number">
                                <span class="row-number">{{ row_number }}</span>
                            </td>
                            <td class="col-name">
                                <span class="file-name" data-file-id="{{ file[0] }}">
                                    <strong>{{ file[1][:50] }}{% if file[1]|length > 50 %}...{% endif %}</strong>
                                </span>
                            </td>
                            <td class="col-type">
                                <span class="badge badge-type">{{ file[4]|upper if file[4] else '' }}</span>
                            </td>
                            <td class="col-size">
                                <span class="badge badge-size">
                                    {% if file[3] > 1048576 %}
                                        {{ (file[3] / 1048576)|round(1) }} MB
                                    {% else %}
                                        {{ (file[3] / 1024)|round|int }} KB
                                    {% endif %}
                                </span>
                            </td>
                            <td class="col-source">{{ file[8] }}</td>
                            <td class="col-side">{{ file[9] }}</td>
                            <td class="col-status">
                                {% if file[5] == 'Read' %}
                                    <span class="badge badge-success">
                                        <i class="bi bi-check-circle"></i>
                                        {{ _('Read') }}
                                    </span>
                                {% else %}
                                    <span class="badge badge-secondary">
                                        <i class="bi bi-dash-circle"></i>
                                        {{ _('Unread') }}
                                    </span>
                                {% endif %}
                            </td>
                            <td class="col-date">
                                {% if file[7] %}
                                    {{ file[7].strftime('%Y-%m-%d') }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="col-actions">
                                <div class="action-buttons">
                                    <a href="{{ url_for('files.file_detail', file_id=file[0]) }}" 
                                       class="btn-action-icon" 
                                       title="{{ _('View Details') }}">
                                        <i class="bi bi-eye"></i>
                                    </a>
   <!--                                 <button class="btn-action-icon btn-danger" 
                                            onclick="deleteFile({{ file[0] }})" 
                                            title="{{ _('Delete') }}">
                                        <i class="bi bi-trash"></i>
                                    </button> -->
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="10" class="empty-state">
                                <div class="empty-state-content">
                                    <i class="bi bi-inbox"></i>
                                    <p>{{ _('No files found.') }}</p>
                                    <a href="{{ url_for('files.upload_page') }}" class="btn btn-primary">
                                        {{ _('Upload your first file') }}
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Grid View -->
        <div class="files-view files-view-grid" data-view="grid" style="display: none;">
            <div class="files-grid" id="filesGrid">
                {% for file in files %}
                <div class="file-card" 
                     data-file-id="{{ file[0] }}" 
                     data-size="{{ file[3] }}"
                     data-type="{{ file[4] }}"
                     data-status="{{ file[5] }}">
                    <input type="checkbox" 
                           class="file-checkbox file-card-checkbox" 
                           value="{{ file[0] }}" 
                           onclick="event.stopPropagation(); updateBulkToolbar();">
                    <div class="file-card-icon">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                    <h6 class="file-card-title">{{ file[1][:30] }}{% if file[1]|length > 30 %}...{% endif %}</h6>
                    <div class="file-card-badges">
                        <span class="badge badge-type">{{ file[4]|upper if file[4] else '' }}</span>
                        {% if file[5] == 'Read' %}
                            <span class="badge badge-success">✓</span>
                        {% endif %}
                    </div>
                    <div class="file-card-stats">
                        <div class="file-stat">
                            <i class="bi bi-hdd"></i>
                            <span>{{ (file[3] / 1024)|round|int }} KB</span>
                        </div>
                        <div class="file-stat">
                            <i class="bi bi-calendar"></i>
                            <span>{{ file[7].strftime('%m/%d') if file[7] else 'N/A' }}</span>
                        </div>
                    </div>
                    <div class="file-card-actions">
                        <button class="btn btn-sm btn-primary" onclick="quickPreview({{ file[0] }}); event.stopPropagation();">
                            <i class="bi bi-eye"></i>
                        </button>
                        <a href="{{ url_for('files.file_detail', file_id=file[0]) }}" 
                           class="btn btn-sm btn-outline-primary" 
                           onclick="event.stopPropagation();">
                            <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-container" id="paginationContainer">
        <div class="pagination-info" id="paginationInfo">
            {% if files and files|length > 0 %}
                {{ _('Page') }} {{ page|default(1) }} {{ _('of') }} {{ total_pages|default(1) }}
            {% else %}
                {{ _('No records') }}
            {% endif %}
        </div>
        <nav>
            <ul class="pagination pagination-sm mb-0" id="paginationList">
                <!-- Pagination buttons will be rendered by JavaScript -->
            </ul>
        </nav>
    </div>
</div>

<!-- Server Data for JavaScript -->
<script>
    window.fileManagementData = {
        totalFiles: {{ total_files|default(0) }},
        limit: {{ limit|default(10) }},
        startPosition: {{ start_position|default(1) }},
        currentPage: {{ page|default(1) }},
        totalPages: {{ total_pages|default(1) }},
        search: {{ search|tojson }},
        sourceFilter: {{ source_filter|tojson }},
        sideFilter: {{ side_filter|tojson }},
        statusFilter: {{ status_filter|tojson }},
        fileTypeFilter: {{ file_type_filter|tojson }}
    };
</script>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/files-management.js') }}"></script>
<script>
    // Initialize translations
    window.translations = {
        pleaseSelectFilesToAnalyze: {{ _('Please select files to analyze')|tojson }},
        analysisStartedFor: {{ _('Analysis started for')|tojson }},
        files: {{ _('files')|tojson }},
        errorStartingAnalysis: {{ _('Error starting analysis')|tojson }},
        pleaseSelectFilesToExport: {{ _('Please select files to export')|tojson }},
        pleaseSelectFilesToDelete: {{ _('Please select files to delete')|tojson }},
        deleteFilesConfirm: {{ _('Delete files? This cannot be undone.')|tojson }},
        deletedFiles: {{ _('Deleted')|tojson }},
        errorDeletingFiles: {{ _('Error deleting files')|tojson }},
        deleteFileConfirm: {{ _('Delete this file? This cannot be undone.')|tojson }},
        fileDeleted: {{ _('File deleted')|tojson }},
        errorDeletingFile: {{ _('Error deleting file')|tojson }}
    };
</script>
{% endblock %}
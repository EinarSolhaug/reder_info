{% extends "base.html" %}

{% block title %}{{ _('Import/Export') }}{% endblock %}

{% block extra_css %}
<style>
    .import-export-card {
        transition: all 0.3s ease;
    }
    .import-export-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <h1 class="page-title">
        <i class="bi bi-upload me-2"></i>
        {{ _('Import/Export') }}
    </h1>
    <p class="text-muted">{{ _('Batch file import, database backup, and settings management') }}</p>
</div>

<div class="row">
    <!-- Batch File Import -->
    <div class="col-md-6 mb-4">
        <div class="stat-card import-export-card">
            <h5 class="mb-3">
                <i class="bi bi-file-earmark-arrow-up me-2"></i>
                {{ _('Batch File Import') }}
            </h5>
            
            <div class="mb-3">
                <label class="form-label">{{ _('Import Method') }}</label>
                <select class="form-select" id="importMethod">
                    <option value="paths">{{ _('File Paths List') }}</option>
                    <option value="csv">{{ _('CSV File') }}</option>
                </select>
            </div>

            <!-- File Paths Method -->
            <div id="pathsMethod" class="import-method">
                <div class="mb-3">
                    <label class="form-label">{{ _('File Paths (one per line)') }}</label>
                    <textarea class="form-control" id="filePaths" rows="5" 
                              placeholder="/path/to/file1.pdf&#10;/path/to/file2.docx"></textarea>
                </div>
            </div>

            <!-- CSV Method -->
            <div id="csvMethod" class="import-method" style="display: none;">
                <div class="mb-3">
                    <label class="form-label">{{ _('CSV File') }}</label>
                    <input type="file" class="form-control" id="csvFile" accept=".csv">
                    <small class="text-muted">{{ _('CSV should have a file_path column') }}</small>
                </div>
            </div>

            <div class="row g-2 mb-3">
                <div class="col-md-6">
                    <label class="form-label">{{ _('Source ID') }}</label>
                    <input type="number" class="form-control" id="importSourceId" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">{{ _('Side ID') }}</label>
                    <input type="number" class="form-control" id="importSideId" required>
                </div>
            </div>

            <button class="btn btn-primary w-100" onclick="handleBatchImport()">
                <i class="bi bi-upload me-1"></i>{{ _('Import Files') }}
            </button>

            <div id="importProgress" class="mt-3" style="display: none;">
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <small class="text-muted mt-2 d-block" id="importStatus"></small>
            </div>

            <div id="importResults" class="mt-3"></div>
        </div>
    </div>

    <!-- Database Backup -->
    <div class="col-md-6 mb-4">
        <div class="stat-card import-export-card">
            <h5 class="mb-3">
                <i class="bi bi-database me-2"></i>
                {{ _('Database Backup') }}
            </h5>
            
            <div class="mb-3">
                <button class="btn btn-outline-primary w-100 mb-2" onclick="exportDatabaseBackup()">
                    <i class="bi bi-download me-1"></i>{{ _('Export Backup') }}
                </button>
                <button class="btn btn-outline-secondary w-100" onclick="document.getElementById('backupFile').click()">
                    <i class="bi bi-upload me-1"></i>{{ _('Import Backup') }}
                </button>
                <input type="file" id="backupFile" accept=".zip" style="display: none;" onchange="importDatabaseBackup(this.files[0])">
            </div>

            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="includeData" checked>
                <label class="form-check-label" for="includeData">
                    {{ _('Include data in backup') }}
                </label>
            </div>

            <div id="backupResults" class="mt-3"></div>
        </div>
    </div>

    <!-- Settings Export/Import -->
    <div class="col-md-6 mb-4">
        <div class="stat-card import-export-card">
            <h5 class="mb-3">
                <i class="bi bi-gear me-2"></i>
                {{ _('Settings') }}
            </h5>
            
            <div class="mb-3">
                <button class="btn btn-outline-primary w-100 mb-2" onclick="exportSettings()">
                    <i class="bi bi-download me-1"></i>{{ _('Export Settings') }}
                </button>
                <button class="btn btn-outline-secondary w-100" onclick="document.getElementById('settingsFile').click()">
                    <i class="bi bi-upload me-1"></i>{{ _('Import Settings') }}
                </button>
                <input type="file" id="settingsFile" accept=".json" style="display: none;" onchange="importSettings(this.files[0])">
            </div>

            <div id="settingsResults" class="mt-3"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Switch import method
    document.getElementById('importMethod').addEventListener('change', function() {
        const method = this.value;
        document.getElementById('pathsMethod').style.display = method === 'paths' ? 'block' : 'none';
        document.getElementById('csvMethod').style.display = method === 'csv' ? 'block' : 'none';
    });

    // Batch import
    async function handleBatchImport() {
        const method = document.getElementById('importMethod').value;
        const sourceId = document.getElementById('importSourceId').value;
        const sideId = document.getElementById('importSideId').value;

        if (!sourceId || !sideId) {
            alert('{{ _("Please enter Source ID and Side ID") }}');
            return;
        }

        const progressDiv = document.getElementById('importProgress');
        const resultsDiv = document.getElementById('importResults');
        progressDiv.style.display = 'block';
        resultsDiv.innerHTML = '';

        try {
            let response;
            const formData = new FormData();

            if (method === 'paths') {
                const paths = document.getElementById('filePaths').value.split('\n').filter(p => p.trim());
                if (paths.length === 0) {
                    alert('{{ _("Please enter at least one file path") }}');
                    return;
                }

                response = await fetch('/api/import-export/batch-import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                    },
                    body: JSON.stringify({
                        file_paths: paths,
                        source_id: parseInt(sourceId),
                        side_id: parseInt(sideId)
                    })
                });
            } else {
                const file = document.getElementById('csvFile').files[0];
                if (!file) {
                    alert('{{ _("Please select a CSV file") }}');
                    return;
                }

                formData.append('file', file);
                formData.append('source_id', sourceId);
                formData.append('side_id', sideId);

                response = await fetch('/api/import-export/batch-import/csv', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                    },
                    body: formData
                });
            }

            const data = await response.json();
            
            if (data.success) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>{{ _("Import Complete") }}</strong><br>
                        {{ _("Total") }}: ${data.results.total}<br>
                        {{ _("Successful") }}: ${data.results.successful}<br>
                        {{ _("Failed") }}: ${data.results.failed}
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `<div class="alert alert-danger">${data.error || '{{ _("Import failed") }}'}</div>`;
            }

        } catch (error) {
            console.error('Import error:', error);
            resultsDiv.innerHTML = `<div class="alert alert-danger">{{ _("Error") }}: ${error.message}</div>`;
        } finally {
            progressDiv.style.display = 'none';
        }
    }

    // Export database backup
    async function exportDatabaseBackup() {
        const includeData = document.getElementById('includeData').checked;
        
        try {
            const response = await fetch(`/api/import-export/backup/export?include_data=${includeData}`);
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `database_backup_${new Date().toISOString().split('T')[0]}.zip`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } catch (error) {
            console.error('Export error:', error);
            alert('{{ _("Error exporting backup") }}: ' + error.message);
        }
    }

    // Import database backup
    async function importDatabaseBackup(file) {
        if (!file) return;

        const resultsDiv = document.getElementById('backupResults');
        resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';

        try {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/api/import-export/backup/import', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: formData
            });

            const data = await response.json();
            
            if (data.success) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>{{ _("Backup Valid") }}</strong><br>
                        {{ _("Tables") }}: ${data.results.table_count}<br>
                        ${data.results.warnings && data.results.warnings.length > 0 ? 
                            '<small>' + data.results.warnings.join('<br>') + '</small>' : ''}
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `<div class="alert alert-danger">${data.results.error || '{{ _("Invalid backup") }}'}</div>`;
            }

        } catch (error) {
            console.error('Import error:', error);
            resultsDiv.innerHTML = `<div class="alert alert-danger">{{ _("Error") }}: ${error.message}</div>`;
        }
    }

    // Export settings
    async function exportSettings() {
        try {
            const response = await fetch('/api/import-export/settings/export');
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `settings_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } catch (error) {
            console.error('Export error:', error);
            alert('{{ _("Error exporting settings") }}: ' + error.message);
        }
    }

    // Import settings
    async function importSettings(file) {
        if (!file) return;

        const resultsDiv = document.getElementById('settingsResults');
        resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';

        try {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/api/import-export/settings/import', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: formData
            });

            const data = await response.json();
            
            if (data.success) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>{{ _("Settings Valid") }}</strong><br>
                        <small>{{ _("Note: Use Settings page to apply imported settings") }}</small>
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `<div class="alert alert-danger">${data.results.error || '{{ _("Invalid settings file") }}'}</div>`;
            }

        } catch (error) {
            console.error('Import error:', error);
            resultsDiv.innerHTML = `<div class="alert alert-danger">{{ _("Error") }}: ${error.message}</div>`;
        }
    }
</script>
{% endblock %}


<!-- templates/analysis_batch.html - COMPLETELY ENHANCED -->
{% extends "base.html" %}

{% block title %}{{ _('Batch Analysis') }}{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet" >
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="bi bi-lightning-charge me-2"></i>
        {{ _('Batch Analysis') }}
    </h1>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#templatesModal">
            <i class="bi bi-bookmark me-1"></i>
            {{ _('Templates') }}
        </button>
        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#historyModal">
            <i class="bi bi-clock-history me-1"></i>
            {{ _('History') }}
        </button>
    </div>
</div>

<!-- Analysis View Navigation -->
<div class="analysis-view-navigation" style="margin-bottom: 2rem; border-bottom: 2px solid var(--border-color); padding-bottom: 1rem; background: var(--bg-section); padding: 1rem; border-radius: 8px;">
    <div class="d-flex gap-2 flex-wrap">
        <a href="{{ url_for('archives_page') }}" class="btn btn-outline-primary analysis-view-btn {% if request.endpoint == 'archives_page' %}active{% endif %}" data-view="file">
            <i class="bi bi-archive"></i> {{ _('File Analysis') }}
        </a>
        <a href="{{ url_for('path_analysis_page') }}" class="btn btn-outline-primary analysis-view-btn {% if request.endpoint == 'path_analysis_page' %}active{% endif %}" data-view="path">
            <i class="bi bi-briefcase"></i> {{ _('Path Analysis') }}
        </a>
        <a href="{{ url_for('analysis_batch') }}" class="btn btn-outline-primary analysis-view-btn {% if request.endpoint == 'analysis_batch' %}active{% endif %}" data-view="batch">
            <i class="bi bi-lightning-charge"></i> {{ _('Batch Analysis') }}
        </a>
    </div>
</div>
<!-- Performance Metrics -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex align-items-center">
                <div class="stat-card-icon me-3" style="background: var(--alert-success-bg); color: var(--success-color);">
                    <i class="bi bi-speedometer2"></i>
                </div>
                <div>
                    <div class="stat-card-title">{{ _('Avg Speed') }}</div>
                    <h3 class="stat-card-value mb-0">{{ "%.1f"|format(avg_processing_time) }}s</h3>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex align-items-center">
                <div class="stat-card-icon me-3" style="background: var(--alert-info-bg); color: var(--primary-color);">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div>
                    <div class="stat-card-title">{{ _('Success Rate') }}</div>
                    <h3 class="stat-card-value mb-0">{{ "%.1f"|format(success_rate) }}%</h3>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex align-items-center">
                <div class="stat-card-icon me-3" style="background: var(--alert-warning-bg); color: var(--warning-color);">
                    <i class="bi bi-clock"></i>
                </div>
                <div>
                    <div class="stat-card-title">{{ _('Est. Time') }}</div>
                    <h3 class="stat-card-value mb-0" id="estimatedTime">{{ "%.1f"|format(estimated_time) }}m</h3>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex align-items-center">
                <div class="stat-card-icon me-3" style="background: var(--alert-danger-bg); color: var(--danger-color);">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <div>
                    <div class="stat-card-title">{{ _('Queue Size') }}</div>
                    <h3 class="stat-card-value mb-0">{{ queue_size }}</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analysis Controls -->
<div class="stat-card mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">
            <i class="bi bi-hourglass-split me-2"></i>
            {{ _('Pending Analysis') }}: {{ unanalyzed|length }} {{ _('files') }}
        </h5>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm" onclick="selectAll()">
                <i class="bi bi-check-all"></i> {{ _('Select All') }}
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="deselectAll()">
                <i class="bi bi-x"></i> {{ _('Deselect All') }}
            </button>
            <button class="btn btn-outline-success btn-sm" onclick="selectHighPriority()">
                <i class="bi bi-star"></i> {{ _('High Priority') }}
            </button>
        </div>
    </div>
    
    <!-- Priority & Scheduling -->
    <div class="row g-3 mb-3">
        <div class="col-md-3">
            <label class="form-label small">{{ _('Priority Level') }}</label>
            <select id="prioritySelect" class="form-select form-select-sm">
                <option value="">{{ _('All Priorities') }}</option>
                <option value="high">{{ _('High') }}</option>
                <option value="medium">{{ _('Medium') }}</option>
                <option value="low">{{ _('Low') }}</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label small">{{ _('Schedule') }}</label>
            <select id="scheduleSelect" class="form-select form-select-sm">
                <option value="now">{{ _('Run Now') }}</option>
                <option value="off-hours">{{ _('Off-Hours (11 PM)') }}</option>
                <option value="custom">{{ _('Custom Time') }}</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label small">{{ _('Error Handling') }}</label>
            <select id="errorHandling" class="form-select form-select-sm">
                <option value="retry">{{ _('Retry Failed') }}</option>
                <option value="skip">{{ _('Skip Failed') }}</option>
                <option value="stop">{{ _('Stop on Error') }}</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label small">{{ _('Resource Limit') }}</label>
            <select id="resourceLimit" class="form-select form-select-sm">
                <option value="unlimited">{{ _('Unlimited') }}</option>
                <option value="50">50% {{ _('CPU') }}</option>
                <option value="25">25% {{ _('CPU') }}</option>
            </select>
        </div>
    </div>
    
    <!-- Enhanced Filters -->
    <div class="row g-3 mb-3">
        <div class="col-md-3">
            <label class="form-label small">{{ _('Source Filter') }}</label>
            <select id="sourceFilter" class="form-select form-select-sm">
                <option value="">{{ _('All Sources') }}</option>
                {% for sid, sname in sources.items() %}
                <option value="{{ sid }}">{{ sname }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label small">{{ _('Side Filter') }}</label>
            <select id="sideFilter" class="form-select form-select-sm">
                <option value="">{{ _('All Sides') }}</option>
                {% for sid, sname in sides.items() %}
                <option value="{{ sid }}">{{ sname }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label small">{{ _('File Type') }}</label>
            <select id="fileTypeFilter" class="form-select form-select-sm">
                <option value="">{{ _('All Types') }}</option>
                <option value=".PDF">PDF</option>
                <option value=".DOCX">{{ _('Word') }}</option>
                <option value=".XLSX">{{ _('Excel') }}</option>
                <option value=".TXT">{{ _('Text') }}</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label small">{{ _('Size Range') }}</label>
            <select id="sizeFilter" class="form-select form-select-sm">
                <option value="">{{ _('All Sizes') }}</option>
                <option value="small">< 1MB</option>
                <option value="medium">1-10MB</option>
                <option value="large">> 10MB</option>
            </select>
        </div>
    </div>
    
    <!-- File List with Numbering -->
    <div style="max-height: 400px; overflow-y: auto;">
        <table class="table table-hover table-sm mb-0">
            <thead class="sticky-top bg-white">
                <tr>
                    <th width="40"><input type="checkbox" id="selectAllCheckbox" onchange="toggleAll(this)"></th>
                    <th width="50">#</th>
                    <th>{{ _('File Name') }}</th>
                    <th>{{ _('Type') }}</th>
                    <th>{{ _('Size') }}</th>
                    <th>{{ _('Source') }}</th>
                    <th>{{ _('Priority') }}</th>
                </tr>
            </thead>
            <tbody id="fileTableBody">
                {% for file in unanalyzed %}
                <tr class="file-row" data-source="{{ file[4] }}" data-side="{{ file[5] }}">
                    <td><input type="checkbox" class="file-checkbox" value="{{ file[0] }}"></td>
                    <td><span class="badge bg-secondary">{{ loop.index }}</span></td>
                    <td>
                        <i class="bi bi-file-earmark me-1"></i>
                        {{ file[1][:50] }}{% if file[1]|length > 50 %}...{% endif %}
                    </td>
                    <td><span class="badge bg-secondary">{{ file[3] }}</span></td>
                    <td>{{ (file[2] / 1024)|round|int }} KB</td>
                    <td>{{ file[4] }}</td>
                    <td>
                        <span class="priority-badge priority-medium">
                            <i class="bi bi-star"></i>
                            {{ _('Medium') }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="d-flex justify-content-between mt-3">
        <div>
            <small class="text-muted">
                <span id="selectedCount">0</span> {{ _('files selected') }}
            </small>
        </div>
        <button class="btn btn-primary" onclick="startAnalysis()" id="analyzeBtn">
            <i class="bi bi-play-circle me-2"></i>
            {{ _('Start Analysis') }}
        </button>
    </div>
</div>

<!-- Progress Card -->
<div id="progressCard" class="stat-card" style="display: none;">
    <h5 class="mb-3">
        <i class="bi bi-gear me-2"></i>
        {{ _('Processing...') }}
    </h5>
    
    <div class="mb-3">
        <div class="d-flex justify-content-between mb-2">
            <span>{{ _('Overall Progress') }}</span>
            <span id="progressText">0%</span>
        </div>
        <div class="progress" style="height: 20px;">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                 style="width: 0%"></div>
        </div>
    </div>
    
    <div class="row g-3 text-center mb-3">
        <div class="col-md-3">
            <div class="p-3 bg-light rounded">
                <div class="text-muted small">{{ _('Completed') }}</div>
                <div class="h4 mb-0" id="completedCount">0</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="p-3 bg-light rounded">
                <div class="text-muted small">{{ _('Processing') }}</div>
                <div class="h4 mb-0" id="processingCount">0</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="p-3 bg-light rounded">
                <div class="text-muted small">{{ _('Remaining') }}</div>
                <div class="h4 mb-0" id="remainingCount">0</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="p-3 bg-light rounded">
                <div class="text-muted small">{{ _('Errors') }}</div>
                <div class="h4 mb-0 text-danger" id="errorCount">0</div>
            </div>
        </div>
    </div>
    
    <div class="mb-3">
        <h6>{{ _('Per-File Progress') }}</h6>
        <div id="fileProgressList" style="max-height: 300px; overflow-y: auto;">
            <!-- File progress items will be added here -->
        </div>
    </div>
    
    <div class="mb-3">
        <small class="text-muted">{{ _('Current') }}: <span id="currentFile">-</span></small>
    </div>
    
    <div class="d-flex gap-2">
        <button class="btn btn-sm btn-warning" onclick="pauseAnalysis()" id="pauseBtn">
            <i class="bi bi-pause-fill me-1"></i>
            {{ _('Pause') }}
        </button>
        <button class="btn btn-sm btn-danger" onclick="stopAnalysis()" id="stopBtn">
            <i class="bi bi-stop-fill me-1"></i>
            {{ _('Stop') }}
        </button>
    </div>
</div>

<!-- Templates Modal -->
<div class="modal fade" id="templatesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Batch Templates') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3" id="templatesContainer">
                    <div class="col-md-6">
                        <div class="template-card">
                            <h6 class="mb-2">{{ _('Quick Analysis') }}</h6>
                            <small class="text-muted d-block mb-2">{{ _('Fast processing, standard settings') }}</small>
                            <button class="btn btn-sm btn-primary w-100" onclick="applyTemplate('quick')">
                                <i class="bi bi-play me-1"></i>
                                {{ _('Apply') }}
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="template-card">
                            <h6 class="mb-2">{{ _('Deep Analysis') }}</h6>
                            <small class="text-muted d-block mb-2">{{ _('Thorough processing, all features') }}</small>
                            <button class="btn btn-sm btn-primary w-100" onclick="applyTemplate('deep')">
                                <i class="bi bi-play me-1"></i>
                                {{ _('Apply') }}
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="template-card">
                            <h6 class="mb-2">{{ _('Off-Hours') }}</h6>
                            <small class="text-muted d-block mb-2">{{ _('Scheduled for 11 PM') }}</small>
                            <button class="btn btn-sm btn-primary w-100" onclick="applyTemplate('offhours')">
                                <i class="bi bi-play me-1"></i>
                                {{ _('Apply') }}
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="template-card">
                            <h6 class="mb-2">{{ _('Save New Template') }}</h6>
                            <small class="text-muted d-block mb-2">{{ _('Create custom template') }}</small>
                            <button class="btn btn-sm btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#saveTemplateModal">
                                <i class="bi bi-plus me-1"></i>
                                {{ _('Create') }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Batch Analysis History') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="history-timeline">
                    <div class="history-item">
                        <h6 class="mb-1">{{ _('Batch') }} #5 - {{ _('Completed') }}</h6>
                        <small class="text-muted">{{ _('Today at 2:30 PM') }}</small>
                        <div class="mt-2">
                            <span class="badge bg-success">1,247 {{ _('files') }}</span>
                            <span class="badge bg-info">98.5% {{ _('success') }}</span>
                            <span class="badge bg-secondary">2.3s {{ _('avg') }}</span>
                        </div>
                    </div>
                    
                    <div class="history-item">
                        <h6 class="mb-1">{{ _('Batch') }} #4 - {{ _('Completed') }}</h6>
                        <small class="text-muted">{{ _('Yesterday at 11:00 PM') }}</small>
                        <div class="mt-2">
                            <span class="badge bg-success">892 {{ _('files') }}</span>
                            <span class="badge bg-info">97.2% {{ _('success') }}</span>
                            <span class="badge bg-secondary">2.1s {{ _('avg') }}</span>
                        </div>
                    </div>
                    
                    <div class="history-item">
                        <h6 class="mb-1">{{ _('Batch') }} #3 - {{ _('Completed') }}</h6>
                        <small class="text-muted">{{ _('2 days ago at 3:15 PM') }}</small>
                        <div class="mt-2">
                            <span class="badge bg-success">1,523 {{ _('files') }}</span>
                            <span class="badge bg-info">99.1% {{ _('success') }}</span>
                            <span class="badge bg-secondary">2.4s {{ _('avg') }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resource Optimization -->
<div class="stat-card mt-4">
    <h5 class="mb-3">
        <i class="bi bi-sliders me-2"></i>
        {{ _('Resource Optimization') }}
    </h5>
    
    <div class="row g-3">
        <div class="col-md-4">
            <div>
                <div class="d-flex justify-content-between mb-1">
                    <small>{{ _('CPU Usage') }}</small>
                    <small class="fw-bold">45%</small>
                </div>
                <div class="resource-meter">
                    <div class="resource-fill" style="width: 45%"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div>
                <div class="d-flex justify-content-between mb-1">
                    <small>{{ _('Memory Usage') }}</small>
                    <small class="fw-bold">62%</small>
                </div>
                <div class="resource-meter">
                    <div class="resource-fill" style="width: 62%"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div>
                <div class="d-flex justify-content-between mb-1">
                    <small>{{ _('Disk I/O') }}</small>
                    <small class="fw-bold">38%</small>
                </div>
                <div class="resource-meter">
                    <div class="resource-fill" style="width: 38%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Translation strings for JavaScript
const translations = {
    pleaseSelectFiles: "{{ _('Please select files to analyze') }}",
    analysisPaused: "{{ _('Analysis paused') }}",
    stopAnalysisConfirm: "{{ _('Stop analysis? Progress will be lost.') }}",
    analysisComplete: "{{ _('Analysis Complete!') }}",
    error: "{{ _('Error') }}",
    file: "{{ _('File') }}",
    success: "{{ _('Success') }}",
    templateApplied: "{{ _('Template applied') }}"
};

let analysisStartTime = null;
let processedFiles = 0;
let totalFiles = 0;
let isPaused = false;

function toggleAll(checkbox) {
    document.querySelectorAll('.file-checkbox').forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateSelectedCount();
    updateEstimatedTime();
}

function selectAll() {
    document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = true);
    document.getElementById('selectAllCheckbox').checked = true;
    updateSelectedCount();
    updateEstimatedTime();
}

function deselectAll() {
    document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAllCheckbox').checked = false;
    updateSelectedCount();
    updateEstimatedTime();
}

function selectHighPriority() {
    document.querySelectorAll('.file-row').forEach(row => {
        const checkbox = row.querySelector('.file-checkbox');
        checkbox.checked = true;
    });
    updateSelectedCount();
    updateEstimatedTime();
}

function updateSelectedCount() {
    const count = document.querySelectorAll('.file-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = count;
}

function updateEstimatedTime() {
    const selectedCount = document.querySelectorAll('.file-checkbox:checked').length;
    const estimatedMinutes = (selectedCount * 2.3 / 60).toFixed(1);
    document.getElementById('estimatedTime').textContent = estimatedMinutes + 'm';
}

async function startAnalysis() {
    const selected = Array.from(document.querySelectorAll('.file-checkbox:checked'))
                          .map(cb => parseInt(cb.value));
    
    if (selected.length === 0) {
        alert(translations.pleaseSelectFiles);
        return;
    }
    
    analysisStartTime = Date.now();
    totalFiles = selected.length;
    processedFiles = 0;
    isPaused = false;
    
    document.getElementById('analyzeBtn').disabled = true;
    document.getElementById('progressCard').style.display = 'block';
    document.getElementById('remainingCount').textContent = totalFiles;
    
    try {
        const response = await fetch('/analysis/batch/process', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({file_ids: selected})
        });
        
        const data = await response.json();
        
        if (response.ok) {
            for (let i = 0; i < data.results.length; i++) {
                if (isPaused) break;
                
                const result = data.results[i];
                const status = result.status === 'success' ? 'success' : 'error';
                
                processedFiles++;
                
                const progress = Math.round((processedFiles / totalFiles) * 100);
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = progress + '%';
                document.getElementById('completedCount').textContent = processedFiles;
                document.getElementById('remainingCount').textContent = totalFiles - processedFiles;
                
                // Add file progress item
                addFileProgressItem(result.file_id, status);
                
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            if (!isPaused) {
                document.getElementById('currentFile').textContent = translations.analysisComplete;
                setTimeout(() => {
                    // âœ… Complete page reload with cache-busting
                    window.location.href = window.location.pathname + '?t=' + Date.now();
                }, 2000);
            }
        }
    } catch (error) {
        alert(translations.error + ': ' + error.message);
        document.getElementById('analyzeBtn').disabled = false;
    }
}

function addFileProgressItem(fileId, status) {
    const container = document.getElementById('fileProgressList');
    const item = document.createElement('div');
    item.className = `file-progress-item ${status}`;
    item.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <span>${translations.file} #${fileId}</span>
            <span class="badge bg-${status === 'success' ? 'success' : 'danger'}">
                ${status === 'success' ? translations.success : translations.error}
            </span>
        </div>
    `;
    container.appendChild(item);
    container.scrollTop = container.scrollHeight;
}

function pauseAnalysis() {
    isPaused = true;
    document.getElementById('pauseBtn').disabled = true;
    alert(translations.analysisPaused);
}

function stopAnalysis() {
    if (confirm(translations.stopAnalysisConfirm)) {
        isPaused = true;
        document.getElementById('progressCard').style.display = 'none';
        document.getElementById('analyzeBtn').disabled = false;
    }
}

function applyTemplate(templateName) {
    alert(`${translations.templateApplied}: "${templateName}"`);
    bootstrap.Modal.getInstance(document.getElementById('templatesModal')).hide();
}

// Filter functionality
document.getElementById('sourceFilter').addEventListener('change', filterRows);
document.getElementById('sideFilter').addEventListener('change', filterRows);
document.getElementById('fileTypeFilter').addEventListener('change', filterRows);
document.getElementById('sizeFilter').addEventListener('change', filterRows);

function filterRows() {
    const sourceFilter = document.getElementById('sourceFilter').value;
    const sideFilter = document.getElementById('sideFilter').value;
    
    document.querySelectorAll('.file-row').forEach(row => {
        const source = row.dataset.source;
        const side = row.dataset.side;
        
        const showSource = !sourceFilter || source.includes(sourceFilter);
        const showSide = !sideFilter || side.includes(sideFilter);
        
        row.style.display = (showSource && showSide) ? '' : 'none';
    });
    
    updateSelectedCount();
    updateEstimatedTime();
}
</script>
{% endblock %}

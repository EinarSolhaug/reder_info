{% extends "base.html" %}

{% block title %}{{ _('Charts Dashboard') }}{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
<style>
    /* Section styling */
    .chart-section {
        margin-bottom: 3rem;
        padding: 2rem;
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .section-header {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }
    
    .section-header h2 {
        margin: 0;
        color: var(--text-heading);
        font-size: 1.5rem;
    }
    
    /* Filter section */
    .filter-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: var(--bg-section);
        border-radius: 8px;
    }
    
    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
    }
    
    .filter-group label {
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-dark);
        font-size: 0.875rem;
    }
    
    .filter-group select {
        padding: 0.5rem;
        border: 1px solid var(--input-border);
        border-radius: 6px;
        font-size: 0.875rem;
        background: var(--card-bg);
    }
    
    .filter-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .btn-filter {
        padding: 0.625rem 1.25rem;
        border: none;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }
    
    .btn-filter-primary {
        background: var(--btn-primary);
        color: var(--text-white);
    }
    
    .btn-filter-primary:hover {
        background: var(--btn-primary-hover);
    }
    
    .btn-filter-secondary {
        background: var(--border-color);
        color: var(--text-dark);
    }
    
    .btn-filter-secondary:hover {
        background: var(--border-dark);
    }
    
    /* Chart containers */
    .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Reduced from 400px */
        gap: 1.5rem; /* Reduced from 2rem */
        margin-top: 1rem; /* Reduced from 1.5rem */
    }
    
    .chart-wrapper {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .chart-header {
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chart-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-heading);
    }
    
    .chart-count {
        font-size: 1rem;
        font-weight: 500;
        color: var(--text-light);
    }
    
    .chart-container-layout {
        min-height: 500px;
        height: 500px;
        position: relative;
        max-width: 100%;
        width: 100%;
        box-sizing: border-box;
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border: 1px solid var(--border-color);
    }
    
    .chart-container-layout[data-legend-position="bottom"] {
        height: 550px;
        min-height: 550px;
    }
    
    .chart-container-layout canvas {
        max-width: 100% !important;
        max-height: 100% !important;
        width: 100% !important;
        height: 100% !important;
        object-fit: contain;
    }
    
    /* Sources section - multiple charts in grid */
    .sources-charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Reduced from 400px */
        gap: 1.5rem; /* Reduced from 2rem */
        margin-top: 1rem; /* Reduced from 1.5rem */
    }
    
    /* Loading skeleton */
    .skeleton-loader {
        background: linear-gradient(90deg, var(--border-light) 25%, var(--border-color) 50%, var(--border-light) 75%);
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s ease-in-out infinite;
        border-radius: 4px;
        min-height: 500px;
    }
    
    @keyframes skeleton-loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    /* Empty state */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 500px;
        padding: 2rem;
        color: var(--text-light);
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: var(--text-muted);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .charts-container,
        .sources-charts-grid {
            grid-template-columns: 1fr;
        }
        
        .filter-row {
            grid-template-columns: 1fr;
        }
    }
    
    /* Dashboard Navigation */
    .dashboard-navigation {
        background: var(--bg-section);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .dashboard-nav-btn {
        transition: all 0.3s ease;
        font-weight: 500;
        text-decoration: none;
    }

    .dashboard-nav-btn.active {
        background-color: var(--btn-primary);
        border-color: var(--btn-primary);
        color: var(--text-white);
    }

    .dashboard-nav-btn:hover:not(.active) {
        background-color: var(--border-color);
        border-color: var(--primary-color);
        color: var(--primary-color);
        text-decoration: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Dashboard Header -->
    <header class="dashboard-header">
        <h1><i class="bi bi-graph-up"></i> {{ _('Charts Dashboard') }}</h1>
        <p>{{ _('Visual analytics with filters - all sections in one view') }}</p>
    </header>

    <!-- Dashboard Navigation Buttons -->
    <div class="dashboard-navigation" style="margin-bottom: 2rem; border-bottom: 2px solid var(--border-color); padding-bottom: 1rem;">
        <div class="d-flex gap-2 flex-wrap">
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary dashboard-nav-btn">
                <i class="bi bi-speedometer2"></i> {{ _('Overview') }}
            </a>
            <a href="{{ url_for('comprehensive_dashboard') }}" class="btn btn-outline-primary dashboard-nav-btn">
                <i class="bi bi-layout-three-columns"></i> {{ _('Comprehensive Dashboard') }}
            </a>
            <a href="{{ url_for('charts_dashboard') }}" class="btn btn-outline-primary dashboard-nav-btn active">
                <i class="bi bi-graph-up"></i> {{ _('Charts Dashboard') }}
            </a>
        </div>
    </div>

    <!-- Files Section -->
    <div class="chart-section" id="section-files">
        <div class="section-header">
            <h2><i class="bi bi-files" aria-hidden="true"></i> {{ _('Files Analysis') }}</h2>
        </div>
        <div class="filter-section" role="search" aria-label="{{ _('Files filters') }}">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="files-filter-category">{{ _('Category') }}</label>
                    <select id="files-filter-category" aria-label="{{ _('Filter by category') }}">
                        <option value="">{{ _('All Categories') }}</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="files-filter-source">{{ _('Source') }}</label>
                    <select id="files-filter-source" aria-label="{{ _('Filter by source') }}">
                        <option value="">{{ _('All Sources') }}</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="files-filter-side">{{ _('Side') }}</label>
                    <select id="files-filter-side" aria-label="{{ _('Filter by side') }}">
                        <option value="">{{ _('All Sides') }}</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="files-filter-keyword">{{ _('Keyword') }}</label>
                    <select id="files-filter-keyword" aria-label="{{ _('Filter by keyword') }}">
                        <option value="">{{ _('All Keywords') }}</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn-filter btn-filter-primary" onclick="applyFilters('files', 'charts')" aria-label="{{ _('Apply filters') }}">
                    <i class="bi bi-search" aria-hidden="true"></i> {{ _('Apply Filters') }}
                </button>
                <button class="btn-filter btn-filter-secondary" onclick="resetFilters('files', 'charts')" aria-label="{{ _('Reset filters') }}">
                    <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i> {{ _('Reset') }}
                </button>
            </div>
        </div>
        <div class="charts-container">
            <div class="chart-wrapper">
                <div class="chart-header">
                    <h3>{{ _('File Types Distribution') }}</h3>
                    <span class="chart-count" id="files-chart-count" aria-live="polite">-</span>
                </div>
                <div class="chart-container-layout" role="img" aria-label="{{ _('File types distribution chart') }}">
                    <canvas id="files-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Categories Section -->
    <div class="chart-section" id="section-categories">
        <div class="section-header">
            <h2><i class="bi bi-collection" aria-hidden="true"></i> {{ _('Categories Analysis') }}</h2>
        </div>
        <div class="filter-section" role="search" aria-label="{{ _('Categories filters') }}">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="categories-filter-source">{{ _('Source') }}</label>
                    <select id="categories-filter-source" aria-label="{{ _('Filter by source') }}">
                        <option value="">{{ _('All Sources') }}</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="categories-filter-side">{{ _('Side') }}</label>
                    <select id="categories-filter-side" aria-label="{{ _('Filter by side') }}">
                        <option value="">{{ _('All Sides') }}</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn-filter btn-filter-primary" onclick="applyFilters('categories', 'charts')" aria-label="{{ _('Apply filters') }}">
                    <i class="bi bi-search" aria-hidden="true"></i> {{ _('Apply Filters') }}
                </button>
                <button class="btn-filter btn-filter-secondary" onclick="resetFilters('categories', 'charts')" aria-label="{{ _('Reset filters') }}">
                    <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i> {{ _('Reset') }}
                </button>
            </div>
        </div>
        <div class="charts-container">
            <div class="chart-wrapper">
                <div class="chart-header">
                    <h3>{{ _('Categories Distribution') }}</h3>
                    <span class="chart-count" id="categories-chart-count" aria-live="polite">-</span>
                </div>
                <div class="chart-container-layout" role="img" aria-label="{{ _('Categories distribution chart') }}">
                    <canvas id="categories-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Keywords Section -->
    <div class="chart-section" id="section-keywords">
        <div class="section-header">
            <h2><i class="bi bi-tags" aria-hidden="true"></i> {{ _('Keywords Analysis') }}</h2>
        </div>
        <div class="filter-section" role="search" aria-label="{{ _('Keywords filters') }}">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="keywords-filter-category">{{ _('Category') }}</label>
                    <select id="keywords-filter-category" aria-label="{{ _('Filter by category') }}">
                        <option value="">{{ _('All Categories') }}</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="keywords-filter-source">{{ _('Source') }}</label>
                    <select id="keywords-filter-source" aria-label="{{ _('Filter by source') }}">
                        <option value="">{{ _('All Sources') }}</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="keywords-filter-side">{{ _('Side') }}</label>
                    <select id="keywords-filter-side" aria-label="{{ _('Filter by side') }}">
                        <option value="">{{ _('All Sides') }}</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn-filter btn-filter-primary" onclick="applyFilters('keywords', 'charts')" aria-label="{{ _('Apply filters') }}">
                    <i class="bi bi-search" aria-hidden="true"></i> {{ _('Apply Filters') }}
                </button>
                <button class="btn-filter btn-filter-secondary" onclick="resetFilters('keywords', 'charts')" aria-label="{{ _('Reset filters') }}">
                    <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i> {{ _('Reset') }}
                </button>
            </div>
        </div>
        <div class="charts-container">
            <div class="chart-wrapper">
                <div class="chart-header">
                    <h3>{{ _('Keywords Distribution') }}</h3>
                    <span class="chart-count" id="keywords-chart-count" aria-live="polite">-</span>
                </div>
                <div class="chart-container-layout" role="img" aria-label="{{ _('Keywords distribution chart') }}">
                    <canvas id="keywords-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Sources Section -->
    <div class="chart-section" id="section-sources">
        <div class="section-header">
            <h2><i class="bi bi-database" aria-hidden="true"></i> {{ _('Sources Analysis') }}</h2>
        </div>
        <div class="filter-section" role="search" aria-label="{{ _('Sources filters') }}">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="sources-filter-filetype">{{ _('File Type') }}</label>
                    <select id="sources-filter-filetype" aria-label="{{ _('Filter by file type') }}">
                        <option value="">{{ _('All File Types') }}</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sources-filter-side">{{ _('Side') }}</label>
                    <select id="sources-filter-side" aria-label="{{ _('Filter by side') }}">
                        <option value="">{{ _('All Sides') }}</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sources-filter-keyword">{{ _('Keyword') }}</label>
                    <select id="sources-filter-keyword" aria-label="{{ _('Filter by keyword') }}">
                        <option value="">{{ _('All Keywords') }}</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn-filter btn-filter-primary" onclick="applyFilters('sources', 'charts')" aria-label="{{ _('Apply filters') }}">
                    <i class="bi bi-search" aria-hidden="true"></i> {{ _('Apply Filters') }}
                </button>
                <button class="btn-filter btn-filter-secondary" onclick="resetFilters('sources', 'charts')" aria-label="{{ _('Reset filters') }}">
                    <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i> {{ _('Reset') }}
                </button>
            </div>
        </div>
        <div class="sources-charts-grid">
            <div class="chart-wrapper">
                <div class="chart-header">
                    <h3>{{ _('File Count by Source') }}</h3>
                    <span class="chart-count" id="sources-count-chart-count" aria-live="polite">-</span>
                </div>
                <div class="chart-container-layout" role="img" aria-label="{{ _('Sources file count chart') }}">
                    <canvas id="sources-chart-count"></canvas>
                </div>
            </div>
            <div class="chart-wrapper">
                <div class="chart-header">
                    <h3>{{ _('Size Distribution by Source') }}</h3>
                    <span class="chart-count" id="sources-size-chart-count" aria-live="polite">-</span>
                </div>
                <div class="chart-container-layout" role="img" aria-label="{{ _('Sources size distribution chart') }}">
                    <canvas id="sources-chart-size"></canvas>
                </div>
            </div>
            <div class="chart-wrapper">
                <div class="chart-header">
                    <h3>{{ _('Processing Rate by Source') }}</h3>
                    <span class="chart-count" id="sources-rate-chart-count" aria-live="polite">-</span>
                </div>
                <div class="chart-container-layout" role="img" aria-label="{{ _('Sources processing rate chart') }}">
                    <canvas id="sources-chart-rate"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Sides Section -->
    <div class="chart-section" id="section-sides">
        <div class="section-header">
            <h2><i class="bi bi-diagram-3" aria-hidden="true"></i> {{ _('Sides Analysis') }}</h2>
        </div>
        <div class="filter-section" role="search" aria-label="{{ _('Sides filters') }}">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="sides-filter-filetype">{{ _('File Type') }}</label>
                    <select id="sides-filter-filetype" aria-label="{{ _('Filter by file type') }}">
                        <option value="">{{ _('All File Types') }}</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sides-filter-category">{{ _('Category') }}</label>
                    <select id="sides-filter-category" aria-label="{{ _('Filter by category') }}">
                        <option value="">{{ _('All Categories') }}</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sides-filter-keyword">{{ _('Keyword') }}</label>
                    <select id="sides-filter-keyword" aria-label="{{ _('Filter by keyword') }}">
                        <option value="">{{ _('All Keywords') }}</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn-filter btn-filter-primary" onclick="applyFilters('sides', 'charts')" aria-label="{{ _('Apply filters') }}">
                    <i class="bi bi-search" aria-hidden="true"></i> {{ _('Apply Filters') }}
                </button>
                <button class="btn-filter btn-filter-secondary" onclick="resetFilters('sides', 'charts')" aria-label="{{ _('Reset filters') }}">
                    <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i> {{ _('Reset') }}
                </button>
            </div>
        </div>
        <div class="charts-container">
            <div class="chart-wrapper">
                <div class="chart-header">
                    <h3>{{ _('Sides Distribution') }}</h3>
                    <span class="chart-count" id="sides-chart-count" aria-live="polite">-</span>
                </div>
                <div class="chart-container-layout" role="img" aria-label="{{ _('Sides statistics chart') }}">
                    <canvas id="sides-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Words Section -->
    <div class="chart-section" id="section-words">
        <div class="section-header">
            <h2><i class="bi bi-fonts" aria-hidden="true"></i> {{ _('Words Analysis') }}</h2>
        </div>
        <div class="filter-section" role="search" aria-label="{{ _('Words filters') }}">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="words-filter-category">{{ _('Category (Optional)') }}</label>
                    <select id="words-filter-category" aria-label="{{ _('Filter by category') }}">
                        <option value="">{{ _('All Categories') }}</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn-filter btn-filter-primary" onclick="applyFilters('words', 'charts')" aria-label="{{ _('Load words') }}">
                    <i class="bi bi-search" aria-hidden="true"></i> {{ _('Load Words') }}
                </button>
                <button class="btn-filter btn-filter-secondary" onclick="resetFilters('words', 'charts')" aria-label="{{ _('Reset filters') }}">
                    <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i> {{ _('Reset') }}
                </button>
            </div>
        </div>
        <div class="charts-container">
            <div class="chart-wrapper">
                <div class="chart-header">
                    <h3>{{ _('Words Distribution') }}</h3>
                    <span class="chart-count" id="words-chart-count" aria-live="polite">-</span>
                </div>
                <div class="chart-container-layout" role="img" aria-label="{{ _('Words distribution chart') }}">
                    <canvas id="words-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/chart.umd.js') }}"></script>
<script>
// ===== TRANSLATION STRINGS =====
const translations = {
    fileType: "{{ _('File Type') }}",
    fileCount: "{{ _('File Count') }}",
    totalSize: "{{ _('Total Size') }}",
    avgSize: "{{ _('Avg Size') }}",
    category: "{{ _('Category') }}",
    wordCount: "{{ _('Word Count') }}",
    fileDensity: "{{ _('File Density') }}",
    keyword: "{{ _('Keyword') }}",
    sourceName: "{{ _('Source Name') }}",
    fileTypes: "{{ _('File Types') }}",
    processed: "{{ _('Processed') }}",
    processingRate: "{{ _('Processing Rate') }}",
    sideName: "{{ _('Side Name') }}",
    importance: "{{ _('Importance') }}",
    sources: "{{ _('Sources') }}",
    
    noFileTypesFound: "{{ _('No file types found') }}",
    noCategoriesFound: "{{ _('No categories found') }}",
    noKeywordsFound: "{{ _('No keywords found') }}",
    noSourcesFound: "{{ _('No sources found') }}",
    noSidesFound: "{{ _('No sides found') }}",
    noWordsFound: "{{ _('No words found') }}",
    errorLoadingData: "{{ _('Error loading data') }}",
    noDataAvailable: "{{ _('No data available') }}",
    unknown: "{{ _('Unknown') }}",
    
    fileTypesLabel: "{{ _('file types') }}",
    categoriesLabel: "{{ _('categories') }}",
    keywordsLabel: "{{ _('keywords') }}",
    sourcesLabel: "{{ _('sources') }}",
    sidesLabel: "{{ _('sides') }}",
    itemsLabel: "{{ _('items') }}",
    filesLabel: "{{ _('files') }}",
    
    files: "{{ _('Files') }}",
    words: "{{ _('Words') }}",
    wordsDistribution: "{{ _('Words Distribution') }}",
    density: "{{ _('Density') }}",
    totalSizeLabel: "{{ _('Total Size') }}",
    avgSizeLabel: "{{ _('Avg Size') }}",
    processingRateLabel: "{{ _('Processing Rate') }}",
    source: "{{ _('Source') }}",
    side: "{{ _('Side') }}",
    word: "{{ _('Word') }}",
    totalFiles: "{{ _('Total Files') }}",
    fileTypesLabel2: "{{ _('File Types') }}"
};

// ===== GLOBAL STATE =====
const state = {
    charts: {},
    filterData: {
        categories: [],
        sources: [],
        sides: [],
        keywords: [],
        fileTypes: []
    }
};

// ===== CONFIGURATION =====
const CONFIG = {
    colors: {
        // Use theme-aware chart colors (will be initialized after DOM loads)
        get primary() {
            return window.ChartColors ? window.ChartColors.getChartColors(10) : 
                   ['#667eea', '#764ba2', '#10b981', '#f59e0b', '#ef4444',
                    '#06b6d4', '#8b5cf6', '#ec4899', '#f97316', '#14b8a6'];
        },
        get success() {
            return window.ChartColors ? window.ChartColors.getThemeColors().success : '#10b981';
        },
        get warning() {
            return window.ChartColors ? window.ChartColors.getThemeColors().warning : '#f59e0b';
        },
        get danger() {
            return window.ChartColors ? window.ChartColors.getThemeColors().danger : '#ef4444';
        },
        get unsorted() {
            return window.ChartColors ? window.ChartColors.getThemeColors().unsorted : '#6c757d';
        }
    },
    chartOptions: {
        animation: { duration: 1500, easing: 'easeInOutQuart' },
        responsive: true,
        maintainAspectRatio: false,
        layout: {
            padding: {
                top: 20,
                right: 20,
                bottom: 30,
                left: 20
            },
            autoPadding: true
        },
        plugins: {
            legend: {
                labels: {
                    font: {
                        size: 14,
                        weight: '500'
                    },
                    padding: 15,
                    boxWidth: 16,
                    usePointStyle: true
                }
            },
            tooltip: {
                padding: 12,
                titleFont: {
                    size: 14,
                    weight: '600'
                },
                bodyFont: {
                    size: 13,
                    weight: '500'
                },
                backgroundColor: 'rgba(0, 0, 0, 0.85)',
                titleColor: window.ChartColors ? window.ChartColors.getThemeColors().textWhite || '#fff' : '#fff',
                bodyColor: window.ChartColors ? window.ChartColors.getThemeColors().textWhite || '#fff' : '#fff',
                borderColor: window.ChartColors ? window.ChartColors.getThemeColors().primary : '#667eea',
                borderWidth: 2,
                cornerRadius: 8
            }
        },
        scales: {
            x: {
                ticks: {
                    font: {
                        size: 12,
                        weight: '500'
                    },
                    padding: 10
                },
                title: {
                    display: true,
                    font: {
                        size: 14,
                        weight: '600'
                    },
                    padding: {
                        top: 10
                    }
                }
            },
            y: {
                ticks: {
                    font: {
                        size: 12,
                        weight: '500'
                    },
                    padding: 10
                },
                title: {
                    display: true,
                    font: {
                        size: 14,
                        weight: '600'
                    },
                    padding: {
                        bottom: 10
                    }
                }
            }
        }
    },
    filterMappings: {
        files: {
            charts: { category: 'files-filter-category', source: 'files-filter-source', 
                    side: 'files-filter-side', keyword: 'files-filter-keyword' }
        },
        categories: {
            charts: { source: 'categories-filter-source', side: 'categories-filter-side' }
        },
        keywords: {
            charts: { category: 'keywords-filter-category', source: 'keywords-filter-source', 
                     side: 'keywords-filter-side' }
        },
        sources: {
            charts: { filetype: 'sources-filter-filetype', side: 'sources-filter-side', 
                     keyword: 'sources-filter-keyword' }
        },
        sides: {
            charts: { filetype: 'sides-filter-filetype', category: 'sides-filter-category',
                     keyword: 'sides-filter-keyword' }
        },
        words: {
            charts: { category: 'words-filter-category' }
        }
    }
};

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
    loadFilterOptions();
    // Load all sections on page load
    loadDataForSection('files', 'charts');
    loadDataForSection('categories', 'charts');
    loadDataForSection('keywords', 'charts');
    loadDataForSection('sources', 'charts');
    loadDataForSection('sides', 'charts');
    loadDataForSection('words', 'charts');
});

// ===== FILTER OPTIONS LOADING =====
async function loadFilterOptions() {
    try {
        await Promise.all([
            loadCategories(),
            loadSources(),
            loadSides(),
            loadKeywords(),
            loadFileTypes()
        ]);
    } catch (error) {
        console.error('Error loading filter options:', error);
    }
}

async function loadCategories() {
    const response = await fetch('/api/categories');
    state.filterData.categories = await response.json();
    
    const selects = [
        'files-filter-category', 'keywords-filter-category',
        'words-filter-category', 'sides-filter-category'
    ];
    selects.forEach(id => populateSelect(id, state.filterData.categories));
}

async function loadSources() {
    const response = await fetch('/api/sources');
    state.filterData.sources = await response.json();
    
    const selects = [
        'files-filter-source', 'categories-filter-source',
        'keywords-filter-source'
    ];
    selects.forEach(id => populateSelect(id, state.filterData.sources));
}

async function loadSides() {
    const response = await fetch('/api/sides');
    state.filterData.sides = await response.json();
    
    const selects = [
        'files-filter-side', 'categories-filter-side',
        'keywords-filter-side', 'sources-filter-side'
    ];
    selects.forEach(id => populateSelect(id, state.filterData.sides));
}

async function loadKeywords() {
    try {
        const response = await fetch('/api/keywords?per_page=100&page=1');
        const data = await response.json();
        
        if (data.success && data.keywords) {
            state.filterData.keywords = data.keywords;
            
            const selects = [
                'files-filter-keyword', 'sources-filter-keyword',
                'sides-filter-keyword'
            ];
            selects.forEach(id => populateSelect(id, state.filterData.keywords, 'id', 'text'));
        }
    } catch (error) {
        console.error('Error loading keywords:', error);
        state.filterData.keywords = [];
    }
}

async function loadFileTypes() {
    const response = await fetch('/api/analytics/file-type-distribution');
    const data = await response.json();
    
    if (data.types) {
        state.filterData.fileTypes = data.types;
        
        const selects = [
            'sources-filter-filetype', 'sides-filter-filetype'
        ];
        selects.forEach(id => populateSelect(id, state.filterData.fileTypes, 'type', 'type'));
    }
}

function populateSelect(selectId, data, valueKey = 'id', textKey = 'name') {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    const firstOption = select.options[0];
    select.innerHTML = '';
    if (firstOption) select.appendChild(firstOption);
    
    data.forEach(item => {
        const option = document.createElement('option');
        option.value = item[valueKey];
        option.textContent = item[textKey];
        select.appendChild(option);
    });
}

// ===== FILTER FUNCTIONS =====
function applyFilters(section, mode) {
    loadDataForSection(section, mode);
}

function resetFilters(section, mode) {
    const filterIds = CONFIG.filterMappings[section][mode];
    Object.values(filterIds).forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
    });
    loadDataForSection(section, mode);
}

function getFilterParams(section, mode) {
    const filterIds = CONFIG.filterMappings[section][mode];
    const params = new URLSearchParams();
    
    Object.entries(filterIds).forEach(([key, id]) => {
        const element = document.getElementById(id);
        if (element && element.value) {
            const paramName = key === 'filetype' ? 'file_type' : 
                            key === 'keyword' ? 'keyword_id' :
                            key === 'category' ? 'category_id' :
                            key === 'source' ? 'source_id' :
                            key === 'side' ? 'side_id' : key;
            params.append(paramName, element.value);
        }
    });
    
    return params;
}

// ===== DATA LOADING =====
async function loadDataForSection(section, mode) {
    const params = getFilterParams(section, mode);
    let apiEndpoint;
    
    if (section === 'words') {
        apiEndpoint = `/api/dashboard/words?${params}`;
    } else {
        apiEndpoint = `/api/dashboard/${section}-filtered?${params}`;
    }
    
    setLoadingState(section, true);
    
    try {
        const response = await fetch(apiEndpoint);
        const data = await response.json();
        
        if (data.success) {
            renderData(section, mode, data);
        } else {
            showError(section, translations.errorLoadingData);
        }
    } catch (error) {
        console.error(`Error loading ${section} ${mode}:`, error);
        showError(section, error.message);
    } finally {
        setLoadingState(section, false);
    }
}

function setLoadingState(section, isLoading) {
    const countIds = {
        'files': ['files-chart-count'],
        'categories': ['categories-chart-count'],
        'keywords': ['keywords-chart-count'],
        'sources': ['sources-count-chart-count', 'sources-size-chart-count', 'sources-rate-chart-count'],
        'sides': ['sides-chart-count'],
        'words': ['words-chart-count']
    };
    
    const ids = countIds[section] || [];
    ids.forEach(countId => {
        const countElement = document.getElementById(countId);
        if (countElement) {
            if (isLoading) {
                countElement.textContent = '...';
            }
        }
    });
}

function showError(section, message) {
    const chartIds = {
        'files': ['files-chart'],
        'categories': ['categories-chart'],
        'keywords': ['keywords-chart'],
        'sources': ['sources-chart-count', 'sources-chart-size', 'sources-chart-rate'],
        'sides': ['sides-chart'],
        'words': ['words-chart']
    };
    
    const ids = chartIds[section] || [];
    ids.forEach(chartId => {
        showEmptyChartState(chartId, message);
    });
}

// ===== DATA RENDERING =====
function renderData(section, mode, data) {
    switch(section) {
        case 'files':
            renderFiles(data);
            break;
        case 'categories':
            renderCategories(data);
            break;
        case 'keywords':
            renderKeywords(data);
            break;
        case 'sources':
            renderSources(data);
            break;
        case 'sides':
            renderSides(data);
            break;
        case 'words':
            renderWords(data);
            break;
    }
}

function renderFiles(data) {
    if (!data.file_types || data.file_types.length === 0) {
        showEmptyChartState('files-chart', translations.noFileTypesFound);
        document.getElementById('files-chart-count').textContent = '0 ' + translations.fileTypesLabel;
        return;
    }
    
    document.getElementById('files-chart-count').textContent = `${data.file_types.length} ${translations.fileTypesLabel}`;
    renderBarChart('files-chart', data.file_types.slice(0, 10), {
        labelKey: 'type',
        valueKey: 'count',
        tooltipCallback: (index) => {
            const type = data.file_types[index];
            return [
                `${translations.files}: ${type.count.toLocaleString()}`,
                `${translations.totalSizeLabel}: ${formatFileSize(type.total_size)}`,
                `${translations.avgSizeLabel}: ${formatFileSize(type.avg_size)}`
            ];
        }
    });
}

function renderCategories(data) {
    if (!data.categories || data.categories.length === 0) {
        showEmptyChartState('categories-chart', translations.noCategoriesFound);
        document.getElementById('categories-chart-count').textContent = '0 ' + translations.categoriesLabel;
        return;
    }
    
    document.getElementById('categories-chart-count').textContent = `${data.categories.length} ${translations.categoriesLabel}`;
    renderBarChart('categories-chart', data.categories.slice(0, 15), {
        labelKey: 'name',
        valueKey: 'file_density',
        tooltipCallback: (index) => {
            const cat = data.categories[index];
            return [
                `${translations.density}: ${cat.file_density.toFixed(2)}`,
                `${translations.files}: ${cat.file_count.toLocaleString()}`,
                `${translations.words}: ${cat.word_count.toLocaleString()}`
            ];
        }
    });
}

function renderKeywords(data) {
    if (!data.keywords || data.keywords.length === 0) {
        showEmptyChartState('keywords-chart', translations.noKeywordsFound);
        document.getElementById('keywords-chart-count').textContent = '0 ' + translations.keywordsLabel;
        return;
    }
    
    const validKeywords = data.keywords.filter(kw => 
        kw && (kw.text !== undefined && kw.text !== null) && 
        (kw.file_density !== undefined && kw.file_density !== null)
    );
    
    if (validKeywords.length === 0) {
        showEmptyChartState('keywords-chart', translations.noKeywordsFound);
        document.getElementById('keywords-chart-count').textContent = '0 ' + translations.keywordsLabel;
        return;
    }
    
    document.getElementById('keywords-chart-count').textContent = `${validKeywords.length} ${translations.keywordsLabel}`;
    
    const chartData = validKeywords.slice(0, 15);
    const allDensityZero = chartData.every(kw => !kw.file_density || kw.file_density === 0);
    const valueKey = allDensityZero ? 'file_count' : 'file_density';
    
    const sortedData = [...chartData].sort((a, b) => {
        const valA = allDensityZero ? (a.file_count || 0) : (a.file_density || 0);
        const valB = allDensityZero ? (b.file_count || 0) : (b.file_density || 0);
        return valB - valA;
    });
    
    renderBarChart('keywords-chart', sortedData, {
        labelKey: 'text',
        valueKey: valueKey,
        maxLabelLength: 25,
        tooltipCallback: (index) => {
            const kw = sortedData[index];
            if (!kw) return [];
            return [
                `${translations.keyword}: ${kw.text || translations.unknown}`,
                `${translations.density}: ${(kw.file_density || 0).toFixed(2)}`,
                `${translations.files}: ${(kw.file_count || 0).toLocaleString()}`,
                `${translations.words}: ${(kw.word_count || 0).toLocaleString()}`
            ];
        }
    });
}

function renderSources(data) {
    if (!data.sources || data.sources.length === 0) {
        showEmptyChartState('sources-chart-count', translations.noSourcesFound);
        showEmptyChartState('sources-chart-size', translations.noSourcesFound);
        showEmptyChartState('sources-chart-rate', translations.noSourcesFound);
        ['sources-count-chart-count', 'sources-size-chart-count', 'sources-rate-chart-count'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = '0 ' + translations.sourcesLabel;
        });
        return;
    }
    
    const count = data.sources.length;
    document.getElementById('sources-count-chart-count').textContent = `${count} ${translations.sourcesLabel}`;
    document.getElementById('sources-size-chart-count').textContent = `${count} ${translations.sourcesLabel}`;
    document.getElementById('sources-rate-chart-count').textContent = `${count} ${translations.sourcesLabel}`;
    
    renderBarChart('sources-chart-count', data.sources.slice(0, 15), {
        labelKey: 'name',
        valueKey: 'file_count',
        tooltipCallback: (index) => {
            const src = data.sources[index];
            return [
                `${translations.files}: ${src.file_count.toLocaleString()}`,
                `${translations.totalSizeLabel}: ${formatFileSize(src.total_size)}`,
                `${translations.processingRateLabel}: ${src.processing_rate.toFixed(1)}%`
            ];
        }
    });
    
    renderDoughnutChart('sources-chart-size', data.sources.slice(0, 10), {
        labelKey: 'name',
        valueKey: 'total_size',
        tooltipCallback: (index) => {
            const src = data.sources[index];
            return [
                `${translations.source}: ${src.name}`,
                `${translations.totalSizeLabel}: ${formatFileSize(src.total_size)}`,
                `${translations.files}: ${src.file_count.toLocaleString()}`
            ];
        }
    });
    
    const sources = data.sources.slice(0, 15);
    const colors = sources.map(s => 
        s.processing_rate >= 90 ? CONFIG.colors.success :
        s.processing_rate >= 70 ? CONFIG.colors.warning : CONFIG.colors.danger
    );
    renderBarChart('sources-chart-rate', sources, {
        labelKey: 'name',
        valueKey: 'processing_rate',
        customColors: colors,
        yMax: 100,
        yTicksSuffix: '%',
        tooltipCallback: (index) => {
            const src = sources[index];
            return [
                `${translations.processingRateLabel}: ${src.processing_rate.toFixed(1)}%`,
                `${translations.processed}: ${src.processed_files.toLocaleString()} / ${src.file_count.toLocaleString()}`,
                `${translations.totalFiles}: ${src.file_count.toLocaleString()}`
            ];
        }
    });
}

function renderSides(data) {
    if (!data.sides || data.sides.length === 0) {
        showEmptyChartState('sides-chart', translations.noSidesFound);
        document.getElementById('sides-chart-count').textContent = '0 ' + translations.sidesLabel;
        return;
    }
    
    document.getElementById('sides-chart-count').textContent = `${data.sides.length} ${translations.sidesLabel}`;
    renderBarChart('sides-chart', data.sides.slice(0, 15), {
        labelKey: 'name',
        valueKey: 'file_count',
        tooltipCallback: (index) => {
            const side = data.sides[index];
            return [
                `${translations.side}: ${side.name}`,
                `${translations.importance}: ${side.importance}`,
                `${translations.files}: ${side.file_count.toLocaleString()}`,
                `${translations.totalSizeLabel}: ${formatFileSize(side.total_size)}`,
                `${translations.avgSizeLabel}: ${formatFileSize(side.avg_size)}`
            ];
        }
    });
}

function renderWords(data) {
    if (!data.words || data.words.length === 0) {
        showEmptyChartState('words-chart', translations.noWordsFound);
        document.getElementById('words-chart-count').textContent = '0 ' + translations.itemsLabel;
        return;
    }
    
    // Get selected category name if available
    const categorySelect = document.getElementById('words-filter-category');
    const selectedCategoryId = categorySelect ? categorySelect.value : '';
    let categoryName = '';
    if (selectedCategoryId && data.words.length > 0 && data.words[0].category) {
        categoryName = data.words[0].category;
    }
    
    // Update chart header to show category if selected
    const chartHeader = document.querySelector('#section-words .chart-header h3');
    if (chartHeader) {
        if (categoryName) {
            chartHeader.textContent = `${translations.words || 'Words'} - ${categoryName}`;
        } else {
            // Restore default header text
            chartHeader.textContent = translations.wordsDistribution || 'Words Distribution';
        }
    }
    
    document.getElementById('words-chart-count').textContent = `${data.words.length} ${translations.itemsLabel}`;
    renderBarChart('words-chart', data.words.slice(0, 20), {
        labelKey: 'word',
        valueKey: 'file_count',
        tooltipCallback: (index) => {
            const word = data.words[index];
            const tooltip = [`${translations.word}: ${word.word}`, `${translations.files}: ${word.file_count.toLocaleString()}`];
            if (word.category) {
                tooltip.push(`${translations.category || 'Category'}: ${word.category}`);
            }
            return tooltip;
        }
    });
}

// ===== CHART HELPERS =====
function renderBarChart(canvasId, data, options = {}) {
    const {
        labelKey = 'name',
        valueKey = 'value',
        customColors = null,
        yMax = null,
        yTicksSuffix = '',
        maxLabelLength = 20,
        tooltipCallback = null
    } = options;
    
    if (state.charts[canvasId]) {
        state.charts[canvasId].destroy();
        delete state.charts[canvasId];
    }
    
    const ctx = document.getElementById(canvasId);
    if (!ctx) {
        console.warn(`Canvas element with id '${canvasId}' not found`);
        return;
    }
    
    if (!data || data.length === 0) {
        showEmptyChartState(canvasId, translations.noDataAvailable);
        return;
    }
    
    ctx.style.display = '';
    const chartContainer = ctx.closest('.chart-container-layout');
    if (chartContainer) {
        const emptyStates = chartContainer.querySelectorAll('.empty-state');
        emptyStates.forEach(state => state.remove());
    }
    
    const isVisible = chartContainer && 
                     window.getComputedStyle(chartContainer).display !== 'none' &&
                     window.getComputedStyle(ctx).display !== 'none';
    
    if (!isVisible) {
        requestAnimationFrame(() => {
            renderBarChart(canvasId, data, options);
        });
        return;
    }
    
    if (ctx.offsetWidth === 0 || ctx.offsetHeight === 0) {
        setTimeout(() => {
            renderBarChart(canvasId, data, options);
        }, 100);
        return;
    }
    
    const labels = data.map(item => truncateLabel(item[labelKey], maxLabelLength));
    const values = data.map(item => {
        const val = item[valueKey];
        if (val === null || val === undefined || val === '') return 0;
        const numVal = typeof val === 'string' ? parseFloat(val) : Number(val);
        return isNaN(numVal) ? 0 : numVal;
    });
    const colors = customColors || CONFIG.colors.primary.slice(0, data.length);
    
    try {
        state.charts[canvasId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: valueKey.replace(/_/g, ' ').toUpperCase(),
                    data: values,
                    backgroundColor: colors,
                    borderWidth: 0,
                    borderRadius: 8
                }]
            },
            options: {
                ...CONFIG.chartOptions,
                scales: {
                    x: {
                        ...CONFIG.chartOptions.scales?.x,
                        ticks: {
                            ...CONFIG.chartOptions.scales?.x?.ticks,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            padding: 10
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: yMax,
                        ticks: {
                            ...CONFIG.chartOptions.scales?.y?.ticks,
                            callback: (value) => value + yTicksSuffix,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            padding: 10
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        ...CONFIG.chartOptions.plugins.tooltip,
                        callbacks: {
                            label: (context) => {
                                if (tooltipCallback) {
                                    return tooltipCallback(context.dataIndex);
                                }
                                return `${context.label}: ${context.parsed.y}${yTicksSuffix}`;
                            }
                        }
                    },
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        requestAnimationFrame(() => {
            if (state.charts[canvasId]) {
                try {
                    state.charts[canvasId].resize();
                    state.charts[canvasId].update('none');
                } catch (e) {
                    console.warn(`Error updating chart ${canvasId}:`, e);
                }
            }
        });
        
        setTimeout(() => {
            if (state.charts[canvasId]) {
                try {
                    state.charts[canvasId].resize();
                    state.charts[canvasId].update('none');
                } catch (e) {
                    console.warn(`Error updating chart ${canvasId} (delayed):`, e);
                }
            }
        }, 200);
    } catch (error) {
        console.error(`Error creating chart for ${canvasId}:`, error);
    }
}

function renderDoughnutChart(canvasId, data, options = {}) {
    const {
        labelKey = 'name',
        valueKey = 'value',
        tooltipCallback = null
    } = options;
    
    if (state.charts[canvasId]) {
        state.charts[canvasId].destroy();
        delete state.charts[canvasId];
    }
    
    const ctx = document.getElementById(canvasId);
    if (!ctx) {
        console.warn(`Canvas element with id '${canvasId}' not found`);
        return;
    }
    
    if (!data || data.length === 0) {
        showEmptyChartState(canvasId, translations.noDataAvailable);
        return;
    }
    
    ctx.style.display = '';
    const chartContainer = ctx.closest('.chart-container-layout');
    if (chartContainer) {
        const emptyStates = chartContainer.querySelectorAll('.empty-state');
        emptyStates.forEach(state => state.remove());
    }
    
    const isVisible = chartContainer && 
                     window.getComputedStyle(chartContainer).display !== 'none' &&
                     window.getComputedStyle(ctx).display !== 'none';
    
    if (!isVisible) {
        requestAnimationFrame(() => {
            renderDoughnutChart(canvasId, data, options);
        });
        return;
    }
    
    if (ctx.offsetWidth === 0 || ctx.offsetHeight === 0) {
        setTimeout(() => {
            renderDoughnutChart(canvasId, data, options);
        }, 100);
        return;
    }
    
    const labels = data.map(item => item[labelKey]);
    const values = data.map(item => item[valueKey]);
    
    try {
        state.charts[canvasId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: CONFIG.colors.primary,
                    borderWidth: 2,
                    borderColor: 'var(--text-white)'
                }]
            },
            options: {
                ...CONFIG.chartOptions,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                if (tooltipCallback) {
                                    return tooltipCallback(context.dataIndex);
                                }
                                return `${context.label}: ${context.parsed}`;
                            }
                        }
                    },
                    legend: {
                        display: true,
                        position: 'right',
                        labels: {
                            font: {
                                size: 14,
                                weight: '500'
                            },
                            padding: 15,
                            boxWidth: 16,
                            usePointStyle: true,
                            maxWidth: 250
                        }
                    }
                }
            }
        });
        
        setTimeout(() => {
            if (state.charts[canvasId]) {
                state.charts[canvasId].update('none');
            }
        }, 50);
    } catch (error) {
        console.error(`Error creating chart for ${canvasId}:`, error);
    }
}

// ===== UTILITY FUNCTIONS =====
function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
}

function truncateLabel(label, maxLength) {
    if (!label) return translations.unknown;
    return label.length > maxLength ? label.substring(0, maxLength) + '...' : label;
}

function showEmptyChartState(canvasId, message) {
    if (state.charts[canvasId]) {
        try {
            state.charts[canvasId].destroy();
        } catch (e) {
            console.warn(`Error destroying chart ${canvasId}:`, e);
        }
        delete state.charts[canvasId];
    }
    
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const chartContainer = canvas.closest('.chart-container-layout');
    if (!chartContainer) return;
    
    const existingEmptyState = chartContainer.querySelector('.empty-state');
    if (existingEmptyState) {
        const messageElement = existingEmptyState.querySelector('p');
        if (messageElement) {
            messageElement.textContent = message || translations.noDataAvailable;
        }
        return;
    }
    
    canvas.style.display = 'none';
    
    const emptyStateDiv = document.createElement('div');
    emptyStateDiv.className = 'empty-state';
    emptyStateDiv.style.cssText = 'display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 500px; padding: 2rem;';
    emptyStateDiv.innerHTML = `
        <i class="bi bi-inbox" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;" aria-hidden="true"></i>
        <p style="color: var(--text-light); font-size: 1.1rem; margin: 0;">${message || translations.noDataAvailable}</p>
    `;
    
    chartContainer.appendChild(emptyStateDiv);
}
</script>
{% endblock %}


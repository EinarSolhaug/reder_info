{% extends "base.html" %}

{% block title %}{{ _('Comprehensive Dashboard') }}{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
<style>
    /* Hide all layout content by default */
    .layout-content {
        display: none !important;
    }
    
    /* Show only the active layout */
    .layout-content.active {
        display: block !important;
    }
    
    /* Combined view: show both table and chart */
    .combined-view {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 1.5rem;
        max-width: 100%;
        box-sizing: border-box;
        overflow-x: hidden; /* Prevent horizontal expansion */
        overflow-y: visible; /* Allow legends to extend vertically */
    }
    
    .combined-view-single {
        display: block;
        margin-top: 1.5rem;
    }
    
    /* Chart containers in combined view */
    .combined-view .chart-container-layout {
        min-height: 500px;
        height: 500px;
        position: relative;
        max-width: 100%;
        width: 100%;
        box-sizing: border-box;
        overflow: visible; /* Allow legends to be visible */
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border: 1px solid var(--border-color);
    }
    
    /* Chart containers with bottom legends in combined view */
    .combined-view .chart-container-layout[data-legend-position="bottom"] {
        height: 550px;
        min-height: 550px;
    }
    
    /* Responsive: stack on smaller screens */
    @media (max-width: 1200px) {
        .combined-view {
            grid-template-columns: 1fr;
        }
    }
    
    /* Scrollable containers for tables and results */
    #files-results,
    #categories-results,
    #keywords-results,
    #sources-results,
    #sides-results,
    #words-results {
        max-height: 600px;
        overflow-y: auto;
        overflow-x: auto;
        position: relative;
    }
    
    /* Table responsive wrapper with scrollbars */
    .table-responsive {
        max-width: 100%;
        overflow-x: auto;
        overflow-y: auto;
        max-height: 600px;
        position: relative;
        border: 1px solid var(--border-color);
        border-radius: 8px;
    }
    
    /* Make tables full width within scrollable container */
    .table-responsive table {
        width: 100%;
        min-width: 600px;
    }
    
    /* Custom scrollbar styling */
    .table-responsive::-webkit-scrollbar,
    #files-results::-webkit-scrollbar,
    #categories-results::-webkit-scrollbar,
    #keywords-results::-webkit-scrollbar,
    #sources-results::-webkit-scrollbar,
    #sides-results::-webkit-scrollbar,
    #words-results::-webkit-scrollbar,
    .chart-container-layout::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }
    
    .table-responsive::-webkit-scrollbar-track,
    #files-results::-webkit-scrollbar-track,
    #categories-results::-webkit-scrollbar-track,
    #keywords-results::-webkit-scrollbar-track,
    #sources-results::-webkit-scrollbar-track,
    #sides-results::-webkit-scrollbar-track,
    #words-results::-webkit-scrollbar-track,
    .chart-container-layout::-webkit-scrollbar-track {
        background: var(--border-light);
        border-radius: 10px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb,
    #files-results::-webkit-scrollbar-thumb,
    #categories-results::-webkit-scrollbar-thumb,
    #keywords-results::-webkit-scrollbar-thumb,
    #sources-results::-webkit-scrollbar-thumb,
    #sides-results::-webkit-scrollbar-thumb,
    #words-results::-webkit-scrollbar-thumb,
    .chart-container-layout::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 10px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb:hover,
    #files-results::-webkit-scrollbar-thumb:hover,
    #categories-results::-webkit-scrollbar-thumb:hover,
    #keywords-results::-webkit-scrollbar-thumb:hover,
    #sources-results::-webkit-scrollbar-thumb:hover,
    #sides-results::-webkit-scrollbar-thumb:hover,
    #words-results::-webkit-scrollbar-thumb:hover,
    .chart-container-layout::-webkit-scrollbar-thumb:hover {
        background: var(--btn-primary-hover);
    }
    
    /* Sticky table headers */
    .data-table thead {
        position: sticky;
        top: 0;
        background: var(--bg-section);
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    /* Words grid scrollable */
    .words-grid {
        max-height: 600px;
        overflow-y: auto;
        overflow-x: auto;
        padding: 1rem;
    }
    
    /* Firefox scrollbar styling */
    .table-responsive,
    #files-results,
    #categories-results,
    #keywords-results,
    #sources-results,
    #sides-results,
    #words-results,
    .chart-container-layout {
        scrollbar-width: thin;
        scrollbar-color: var(--primary-color) var(--border-light);
    }
    
    /* Results section styling */
    .results-section {
        min-height: 300px;
        display: flex;
        flex-direction: column;
        overflow-x: hidden; /* Prevent horizontal expansion */
        overflow-y: visible; /* Allow legends to extend vertically */
        max-width: 100%;
        box-sizing: border-box;
    }
    
    /* Ensure charts are properly sized */
    .chart-container-layout canvas {
        max-width: 100% !important;
        max-height: 100% !important;
        width: 100% !important;
        height: 100% !important;
        object-fit: contain;
    }
    
    /* Sources section with multiple chart rows */
    .layout-content .combined-view + .combined-view {
        margin-top: 2rem;
        max-height: 600px;
        overflow-y: auto;
    }
    
    /* Ensure layout content is scrollable */
    .layout-content {
        max-height: calc(100vh - 250px);
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 10px;
        max-width: 100%;
        box-sizing: border-box;
    }
    
    .layout-content::-webkit-scrollbar {
        width: 10px;
    }
    
    .layout-content::-webkit-scrollbar-track {
        background: var(--border-light);
        border-radius: 10px;
    }
    
    .layout-content::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 10px;
    }
    
    .layout-content::-webkit-scrollbar-thumb:hover {
        background: var(--btn-primary-hover);
    }
    
    /* Similar files groups styling */
    .similar-groups-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
    
    .similar-group {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        background: var(--card-bg);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .similar-group-header {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-light);
    }
    
    .similar-group-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
        flex-wrap: wrap;
    }
    
    .similar-group-count {
        font-weight: 600;
        color: var(--primary-color);
    }
    
    .similar-group-hash {
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        color: var(--text-light);
        margin-top: 0.5rem;
    }
    
    .similar-group-hash code {
        background: var(--border-light);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }
    
    .similar-group-title-text {
        font-style: italic;
        color: var(--text-dark);
        margin-top: 0.5rem;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .badge-hash {
        background: var(--alert-info-bg);
        color: var(--info-color);
    }
    
    .badge-title {
        background: var(--alert-danger-bg);
        color: var(--danger-color);
    }
    
    .badge-identical {
        background: var(--alert-success-bg);
        color: var(--success-color);
    }
    
    /* Loading skeleton animation */
    .skeleton-loader {
        background: linear-gradient(90deg, var(--border-light) 25%, var(--border-color) 50%, var(--border-light) 75%);
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s ease-in-out infinite;
        border-radius: 4px;
    }
    
    .skeleton-table {
        width: 100%;
        height: 300px;
    }
    
    .skeleton-chart {
        width: 100%;
        height: 500px;
        border-radius: 12px;
        background: var(--bg-section);
    }
    
    @keyframes skeleton-loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    /* Optimize loading spinner */
    .loading-spinner {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 200px;
        color: var(--primary-color);
        font-size: 1.1rem;
    }
    
    /* Dashboard Navigation */
    .dashboard-navigation {
        background: var(--bg-section);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .dashboard-nav-btn {
        transition: all 0.3s ease;
        font-weight: 500;
        text-decoration: none;
    }

    .dashboard-nav-btn.active {
        background-color: var(--btn-primary);
        border-color: var(--btn-primary);
        color: var(--text-white);
    }

    .dashboard-nav-btn:hover:not(.active) {
        background-color: var(--border-color);
        border-color: var(--primary-color);
        color: var(--primary-color);
        text-decoration: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Dashboard Header -->
    <header class="dashboard-header">
        <h1><i class="bi bi-layout-three-columns"></i> {{ _('Comprehensive Dashboard') }}</h1>
        <p>{{ _('Advanced filtering and analysis across files, categories, keywords, sources, and words') }}</p>
    </header>

    <!-- Dashboard Navigation Buttons -->
    <div class="dashboard-navigation" style="margin-bottom: 2rem; border-bottom: 2px solid var(--border-color); padding-bottom: 1rem;">
        <div class="d-flex gap-2 flex-wrap">
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary dashboard-nav-btn">
                <i class="bi bi-speedometer2"></i> {{ _('Overview') }}
            </a>
            <a href="{{ url_for('comprehensive_dashboard') }}" class="btn btn-outline-primary dashboard-nav-btn active">
                <i class="bi bi-layout-three-columns"></i> {{ _('Comprehensive Dashboard') }}
            </a>
            <a href="{{ url_for('charts_dashboard') }}" class="btn btn-outline-primary dashboard-nav-btn">
                <i class="bi bi-graph-up"></i> {{ _('Charts Dashboard') }}
            </a>
        </div>
    </div>
    <!-- Layout Navigation -->
    <nav class="tab-navigation" role="tablist" aria-label="{{ _('Dashboard views') }}">
        <!-- Files Tab -->
        <button class="tab-button active" 
                role="tab" 
                aria-selected="true" 
                aria-controls="layout-files"
                data-layout="files"
                tabindex="0">
            <i class="bi bi-files" aria-hidden="true"></i> {{ _('Files') }}
        </button>
        
        <!-- Categories Tab -->
        <button class="tab-button" 
                role="tab" 
                aria-selected="false" 
                aria-controls="layout-categories"
                data-layout="categories"
                tabindex="-1">
            <i class="bi bi-collection" aria-hidden="true"></i> {{ _('Categories') }}
        </button>
        
        <!-- Keywords Tab -->
        <button class="tab-button" 
                role="tab" 
                aria-selected="false" 
                aria-controls="layout-keywords"
                data-layout="keywords"
                tabindex="-1">
            <i class="bi bi-tags" aria-hidden="true"></i> {{ _('Keywords') }}
        </button>
        
        <!-- Sources Tab -->
        <button class="tab-button" 
                role="tab" 
                aria-selected="false" 
                aria-controls="layout-sources"
                data-layout="sources"
                tabindex="-1">
            <i class="bi bi-database" aria-hidden="true"></i> {{ _('Sources') }}
        </button>
        
        <!-- Sides Tab -->
        <button class="tab-button" 
                role="tab" 
                aria-selected="false" 
                aria-controls="layout-sides"
                data-layout="sides"
                tabindex="-1">
            <i class="bi bi-diagram-3" aria-hidden="true"></i> {{ _('Sides') }}
        </button>
        
        <!-- Words Tab -->
        <button class="tab-button" 
                role="tab" 
                aria-selected="false" 
                aria-controls="layout-words"
                data-layout="words"
                tabindex="-1">
            <i class="bi bi-fonts" aria-hidden="true"></i> {{ _('Words') }}
        </button>
        
        <!-- Similar Files Tab -->
        <button class="tab-button" 
                role="tab" 
                aria-selected="false" 
                aria-controls="layout-similar"
                data-layout="similar"
                tabindex="-1">
            <i class="bi bi-files-alt" aria-hidden="true"></i> {{ _('Similar Files') }}
        </button>
    </nav>

    <!-- Layout Container -->
    <div id="layouts-container" role="tabpanel">
        <!-- Files Combined Layout -->
        <div class="layout-content active" id="layout-files" role="tabpanel" aria-labelledby="tab-files">
            <div class="layout-header">
                <h2><i class="bi bi-files" aria-hidden="true"></i> {{ _('Files Analysis') }}</h2>
            </div>
            <div class="filter-section" role="search" aria-label="{{ _('Files filters') }}">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="files-filter-category">{{ _('Category') }}</label>
                        <select id="files-filter-category" aria-label="{{ _('Filter by category') }}') }}">
                            <option value="">{{ _('All Categories') }}</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="files-filter-source">{{ _('Source') }}</label>
                        <select id="files-filter-source" aria-label="{{ _('Filter by source') }}') }}">
                            <option value="">{{ _('All Sources') }} </option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="files-filter-side">{{ _('Side') }}</label>
                        <select id="files-filter-side" aria-label="{{ _('Filter by side') }}') }}">
                            <option value="">{{ _('All Sides') }}</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="files-filter-keyword">{{ _('Keyword') }}</label>
                        <select id="files-filter-keyword" aria-label="{{ _('Filter by keyword') }}') }}">
                            <option value="">{{ _('All Keywords') }}</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn-filter btn-filter-primary" onclick="applyFilters('files', 'combined')" aria-label="{{ _('Apply filters') }}">
                        <i class="bi bi-search" aria-hidden="true"></i> {{ _('Apply Filters') }}
                    </button>
                    <button class="btn-filter btn-filter-secondary" onclick="resetFilters('files', 'combined')" aria-label="{{ _('Reset filters') }}">
                        <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i> {{ _('Reset') }}
                    </button>
                </div>
            </div>
            <div class="combined-view">
                <div class="results-section">
                    <div class="results-header">
                        <h3>{{ _('File Types Table') }}</h3>
                        <span class="results-count" id="files-count" aria-live="polite">-</span>
                    </div>
                    <div id="files-results" aria-live="polite" aria-busy="true">
                        <div class="skeleton-loader skeleton-table"></div>
                    </div>
                </div>
                <div class="results-section">
                    <div class="results-header">
                        <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">{{ _('File Types Chart') }}</h3>
                        <span class="results-count" id="files-chart-count" aria-live="polite" style="font-size: 1rem; font-weight: 500;">-</span>
                    </div>
                    <div class="chart-container-layout" role="img" aria-label="{{ _('File types distribution chart') }}">
                        <canvas id="files-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories Combined Layout -->
        <div class="layout-content" id="layout-categories" role="tabpanel" aria-labelledby="tab-categories">
            <div class="layout-header">
                <h2><i class="bi bi-collection" aria-hidden="true"></i> {{ _('Categories Analysis') }}</h2>
            </div>
            <div class="filter-section" role="search" aria-label="{{ _('Categories filters') }}">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="categories-filter-source">{{ _('Source') }}</label>
                        <select id="categories-filter-source" aria-label="{{ _('Filter by source') }}">
                            <option value="">{{ _('All Sources') }}</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="categories-filter-side">{{ _('Side') }} </label>
                        <select id="categories-filter-side" aria-label="{{ _('Filter by side') }}">
                            <option value="">{{ _('All Sides') }}</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn-filter btn-filter-primary" onclick="applyFilters('categories', 'combined')" aria-label="{{ _('Apply filters') }}">
                        <i class="bi bi-search" aria-hidden="true"></i> {{ _('Apply Filters') }}
                    </button>
                    <button class="btn-filter btn-filter-secondary" onclick="resetFilters('categories', 'combined')" aria-label="{{ _('Reset filters') }}">
                        <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i> {{ _('Reset') }}
                    </button>
                </div>
            </div>
            <div class="combined-view">
                <div class="results-section">
                    <div class="results-header">
                        <h3>{{ _('Categories Table') }}</h3>
                        <span class="results-count" id="categories-count" aria-live="polite">-</span>
                    </div>
                    <div id="categories-results" aria-live="polite" aria-busy="false">
                        <div class="skeleton-loader skeleton-table"></div>
                    </div>
                </div>
                <div class="results-section">
                    <div class="results-header">
                        <h3>{{ _('Categories Chart') }}</h3>
                        <span class="results-count" id="categories-chart-count" aria-live="polite">-</span>
                    </div>
                    <div class="chart-container-layout" role="img" aria-label="{{ _('Categories distribution chart') }}">
                        <canvas id="categories-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Keywords Combined Layout -->
        <div class="layout-content" id="layout-keywords" role="tabpanel" aria-labelledby="tab-keywords">
            <div class="layout-header">
                <h2><i class="bi bi-tags" aria-hidden="true"></i> {{ _('Keywords Analysis') }}</h2>
            </div>
            <div class="filter-section" role="search" aria-label="{{ _('Keywords filters') }}">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="keywords-filter-category">{{ _('Category') }}</label>
                        <select id="keywords-filter-category" aria-label="{{ _('Filter by category') }}">
                            <option value="">{{ _('All Categories') }}</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="keywords-filter-source">{{ _('Source') }}</label>
                        <select id="keywords-filter-source" aria-label="{{ _('Filter by source') }}">
                            <option value="">{{ _('All Sources') }}</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="keywords-filter-side">{{ _('Side') }}</label>
                        <select id="keywords-filter-side" aria-label="{{ _('Filter by side') }}">
                            <option value="">{{ _('All Sides') }}</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn-filter btn-filter-primary" onclick="applyFilters('keywords', 'combined')" aria-label="{{ _('Apply filters') }}">
                        <i class="bi bi-search" aria-hidden="true"></i> {{ _('Apply Filters') }}
                    </button>
                    <button class="btn-filter btn-filter-secondary" onclick="resetFilters('keywords', 'combined')" aria-label="{{ _('Reset filters') }}">
                        <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i> {{ _('Reset') }}
                    </button>
                </div>
            </div>
            <div class="combined-view">
                <div class="results-section">
                    <div class="results-header">
                        <h3>{{ _('Keywords Table') }}</h3>
                        <span class="results-count" id="keywords-count" aria-live="polite">-</span>
                    </div>
                    <div id="keywords-results" aria-live="polite" aria-busy="false">
                        <div class="skeleton-loader skeleton-table"></div>
                    </div>
                </div>
                <div class="results-section">
                    <div class="results-header">
                        <h3>{{ _('Keywords Chart') }}</h3>
                        <span class="results-count" id="keywords-chart-count" aria-live="polite">-</span>
                    </div>
                    <div class="chart-container-layout" role="img" aria-label="{{ _('Keywords distribution chart') }}">
                        <canvas id="keywords-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sources Combined Layout -->
        <div class="layout-content" id="layout-sources" role="tabpanel" aria-labelledby="tab-sources">
            <div class="layout-header">
                <h2><i class="bi bi-database" aria-hidden="true"></i> {{ _('Sources Analysis') }}</h2>
            </div>
            <div class="filter-section" role="search" aria-label="{{ _('Sources filters') }}">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="sources-filter-filetype">{{ _('File Type') }}</label>
                        <select id="sources-filter-filetype" aria-label="{{ _('Filter by file type') }}">
                            <option value="">{{ _('All File Types') }}</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="sources-filter-side">{{ _('Side') }}</label>
                        <select id="sources-filter-side" aria-label="{{ _('Filter by side') }}">
                            <option value="">{{ _('All Sides') }}</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="sources-filter-keyword">{{ _('Keyword') }}</label>
                        <select id="sources-filter-keyword" aria-label="{{ _('Filter by keyword') }}">
                            <option value="">{{ _('All Keywords') }}</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn-filter btn-filter-primary" onclick="applyFilters('sources', 'combined')" aria-label="{{ _('Apply filters') }}">
                        <i class="bi bi-search" aria-hidden="true"></i> {{ _('Apply Filters') }}
                    </button>
                    <button class="btn-filter btn-filter-secondary" onclick="resetFilters('sources', 'combined')" aria-label="{{ _('Reset filters') }}">
                        <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i> {{ _('Reset') }}
                    </button>
                </div>
            </div>
            <div class="combined-view">
                <div class="results-section">
                    <div class="results-header">
                        <h3>{{ _('Sources Table') }}</h3>
                        <span class="results-count" id="sources-count" aria-live="polite">-</span>
                    </div>
                    <div id="sources-results" aria-live="polite" aria-busy="false">
                        <div class="skeleton-loader skeleton-table"></div>
                    </div>
                </div>
                <div class="results-section">
                    <div class="results-header">
                        <h3>{{ _('File Count Chart') }}</h3>
                        <span class="results-count" id="sources-count-chart-count" aria-live="polite">-</span>
                    </div>
                    <div class="chart-container-layout" role="img" aria-label="{{ _('Sources file count chart') }}">
                        <canvas id="sources-chart-count"></canvas>
                    </div>
                </div>
            </div>
            <div class="combined-view" style="margin-top: 2rem;">
                <div class="results-section">
                    <div class="results-header">
                        <h3>{{ _('Size Distribution Chart') }}</h3>
                        <span class="results-count" id="sources-size-chart-count" aria-live="polite">-</span>
                    </div>
                    <div class="chart-container-layout" role="img" aria-label="{{ _('Sources size distribution chart') }}">
                        <canvas id="sources-chart-size"></canvas>
                    </div>
                </div>
                <div class="results-section">
                    <div class="results-header">
                        <h3>{{ _('Processing Rate Chart') }}</h3>
                        <span class="results-count" id="sources-rate-chart-count" aria-live="polite">-</span>
                    </div>
                    <div class="chart-container-layout" role="img" aria-label="{{ _('Sources processing rate chart') }}">
                        <canvas id="sources-chart-rate"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sides Combined Layout -->
        <div class="layout-content" id="layout-sides" role="tabpanel" aria-labelledby="tab-sides">
            <div class="layout-header">
                <h2><i class="bi bi-diagram-3" aria-hidden="true"></i> {{ _('Sides Analysis') }}</h2>
            </div>
            <div class="filter-section" role="search" aria-label="{{ _('Sides filters') }}">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="sides-filter-filetype">{{ _('File Type') }}</label>
                        <select id="sides-filter-filetype" aria-label="{{ _('Filter by file type') }}">
                            <option value="">{{ _('All File Types') }}</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="sides-filter-category">{{ _('Category') }}</label>
                        <select id="sides-filter-category" aria-label="{{ _('Filter by category') }}">
                            <option value="">{{ _('All Categories') }}</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="sides-filter-keyword">{{ _('Keyword') }}</label>
                        <select id="sides-filter-keyword" aria-label="{{ _('Filter by keyword') }}">
                            <option value="">{{ _('All Keywords') }}</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn-filter btn-filter-primary" onclick="applyFilters('sides', 'combined')" aria-label="{{ _('Apply filters') }}">
                        <i class="bi bi-search" aria-hidden="true"></i> {{ _('Apply Filters') }}
                    </button>
                    <button class="btn-filter btn-filter-secondary" onclick="resetFilters('sides', 'combined')" aria-label="{{ _('Reset filters') }}">
                        <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i> {{ _('Reset') }}
                    </button>
                </div>
            </div>
            <div class="combined-view">
                <div class="results-section">
                    <div class="results-header">
                        <h3>{{ _('Sides Table') }}</h3>
                        <span class="results-count" id="sides-count" aria-live="polite">-</span>
                    </div>
                    <div id="sides-results" aria-live="polite" aria-busy="false">
                        <div class="skeleton-loader skeleton-table"></div>
                    </div>
                </div>
                <div class="results-section">
                    <div class="results-header">
                        <h3>{{ _('Sides Chart') }}</h3>
                        <span class="results-count" id="sides-chart-count" aria-live="polite">-</span>
                    </div>
                    <div class="chart-container-layout" role="img" aria-label="{{ _('Sides statistics chart') }}">
                        <canvas id="sides-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Words Layout -->
        <div class="layout-content" id="layout-words" role="tabpanel" aria-labelledby="tab-words">
            <div class="layout-header">
                <h2><i class="bi bi-fonts" aria-hidden="true"></i> {{ _('Words Layout') }}</h2>
            </div>
            <div class="filter-section" role="search" aria-label="{{ _('Words filters') }}">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="words-filter-category">{{ _('Category (Optional)') }}</label>
                        <select id="words-filter-category" aria-label="{{ _('Filter by category') }}">
                            <option value="">{{ _('All Categories') }}</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn-filter btn-filter-primary" onclick="applyFilters('words', 'grid')" aria-label="{{ _('Load words') }}">
                        <i class="bi bi-search" aria-hidden="true"></i> {{ _('Load Words') }}
                    </button>
                    <button class="btn-filter btn-filter-secondary" onclick="resetFilters('words', 'grid')" aria-label="{{ _('Reset filters') }}">
                        <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i> {{ _('Reset') }}
                    </button>
                </div>
            </div>
            <div class="results-section">
                <div class="results-header">
                    <h3>{{ _('Words by Category') }}</h3>
                    <button class="btn-filter btn-filter-secondary" onclick="toggleWordsView()" id="toggle-words-view" aria-label="{{ _('Toggle view mode') }}">
                        <i class="bi bi-graph-up" aria-hidden="true"></i> <span id="view-toggle-text">{{ _('Chart View') }}</span>
                    </button>
                </div>
                <div id="words-results" aria-live="polite" aria-busy="false">
                    <div class="skeleton-loader skeleton-table"></div>
                </div>
                <div class="words-chart-container" id="words-chart-container" style="display: none; min-height: 500px; height: 500px; background: var(--bg-white); border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--border-color); position: relative; max-width: 100%; width: 100%; box-sizing: border-box;" role="img" aria-label="{{ _('Words distribution chart') }}">
                    <canvas id="words-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Similar Files Layout -->
        <div class="layout-content" id="layout-similar" role="tabpanel" aria-labelledby="tab-similar">
            <div class="layout-header">
                <h2><i class="bi bi-files-alt" aria-hidden="true"></i> {{ _('Similar Files Analysis') }}</h2>
            </div>
            <div class="filter-section" role="search" aria-label="{{ _('Similar files filters') }}">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="similar-filter-threshold">{{ _('Similarity Threshold') }}</label>
                        <select id="similar-filter-threshold" aria-label="{{ _('Filter by similarity threshold') }}">
                            <option value="0.9">{{ _('Very High (90%+)') }}</option>
                            <option value="0.8" selected>{{ _('High (80%+)') }}</option>
                            <option value="0.7">{{ _('Medium (70%+)') }}</option>
                            <option value="0.6">{{ _('Low (60%+)') }}</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="similar-filter-minsize">{{ _('Min Group Size') }}</label>
                        <select id="similar-filter-minsize" aria-label="{{ _('Minimum files per group') }}">
                            <option value="2" selected>{{ _('2+ files') }}</option>
                            <option value="3">{{ _('3+ files') }}</option>
                            <option value="5">{{ _('5+ files') }}</option>
                            <option value="10">{{ _('10+ files') }}</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="similar-filter-type">{{ _('Group Type') }}</label>
                        <select id="similar-filter-type" aria-label="{{ _('Filter by group type') }}">
                            <option value="">{{ _('All Types') }}</option>
                            <option value="hash">{{ _('Hash Duplicates') }}</option>
                            <option value="title">{{ _('Similar Titles') }}</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn-filter btn-filter-primary" onclick="applyFilters('similar', 'combined')" aria-label="{{ _('Apply filters') }}">
                        <i class="bi bi-search" aria-hidden="true"></i> {{ _('Load Similar Files') }}
                    </button>
                    <button class="btn-filter btn-filter-secondary" onclick="resetFilters('similar', 'combined')" aria-label="{{ _('Reset filters') }}">
                        <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i> {{ _('Reset') }}
                    </button>
                </div>
            </div>
            <div class="results-section">
                <div class="results-header">
                    <h3>{{ _('Similar Files Groups') }}</h3>
                    <span class="results-count" id="similar-count" aria-live="polite">-</span>
                </div>
                <div id="similar-results" aria-live="polite" aria-busy="false">
                    <div class="skeleton-loader skeleton-table"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/chart.umd.js') }}"></script>
<script>
// ===== TRANSLATION STRINGS =====
const translations = {
    // Table Headers
    fileType: "{{ _('File Type') }}",
    fileCount: "{{ _('File Count') }}",
    totalSize: "{{ _('Total Size') }}",
    avgSize: "{{ _('Avg Size') }}",
    category: "{{ _('Category') }}",
    wordCount: "{{ _('Word Count') }}",
    fileDensity: "{{ _('File Density') }}",
    keyword: "{{ _('Keyword') }}",
    sourceName: "{{ _('Source Name') }}",
    fileTypes: "{{ _('File Types') }}",
    processed: "{{ _('Processed') }}",
    processingRate: "{{ _('Processing Rate') }}",
    sideName: "{{ _('Side Name') }}",
    importance: "{{ _('Importance') }}",
    sources: "{{ _('Sources') }}",
    
    // Status Messages
    noFileTypesFound: "{{ _('No file types found') }}",
    noCategoriesFound: "{{ _('No categories found') }}",
    noKeywordsFound: "{{ _('No keywords found') }}",
    noSourcesFound: "{{ _('No sources found') }}",
    noSidesFound: "{{ _('No sides found') }}",
    noWordsFound: "{{ _('No words found') }}",
    noSimilarFilesFound: "{{ _('No similar files found') }}",
    errorLoadingData: "{{ _('Error loading data') }}",
    noDataAvailable: "{{ _('No data available') }}",
    unknown: "{{ _('Unknown') }}",
    groupsLabel: "{{ _('groups') }}",
    hashDuplicate: "{{ _('Hash Duplicate') }}",
    similarTitle: "{{ _('Similar Title') }}",
    fileName: "{{ _('File Name') }}",
    
    // Count Labels
    fileTypesLabel: "{{ _('file types') }}",
    categoriesLabel: "{{ _('categories') }}",
    keywordsLabel: "{{ _('keywords') }}",
    sourcesLabel: "{{ _('sources') }}",
    sidesLabel: "{{ _('sides') }}",
    itemsLabel: "{{ _('items') }}",
    filesLabel: "{{ _('files') }}",
    
    // View Toggle
    gridView: "{{ _('Grid View') }}",
    chartView: "{{ _('Chart View') }}",
    
    // Tooltip Labels
    files: "{{ _('Files') }}",
    words: "{{ _('Words') }}",
    density: "{{ _('Density') }}",
    totalSizeLabel: "{{ _('Total Size') }}",
    avgSizeLabel: "{{ _('Avg Size') }}",
    processingRateLabel: "{{ _('Processing Rate') }}",
    source: "{{ _('Source') }}",
    side: "{{ _('Side') }}",
    word: "{{ _('Word') }}",
    totalFiles: "{{ _('Total Files') }}",
    fileTypesLabel2: "{{ _('File Types') }}"
};

// ===== GLOBAL STATE =====
const state = {
    charts: {},
    filterData: {
        categories: [],
        sources: [],
        sides: [],
        keywords: [],
        fileTypes: []
    },
    currentLayout: 'files',
    wordsViewMode: 'grid'
};

// ===== CONFIGURATION =====
const CONFIG = {
    colors: {
        // Use theme-aware chart colors (will be initialized after DOM loads)
        get primary() {
            return window.ChartColors ? window.ChartColors.getChartColors(10) : 
                   ['#667eea', '#764ba2', '#10b981', '#f59e0b', '#ef4444',
                    '#06b6d4', '#8b5cf6', '#ec4899', '#f97316', '#14b8a6'];
        },
        get success() {
            return window.ChartColors ? window.ChartColors.getThemeColors().success : '#10b981';
        },
        get warning() {
            return window.ChartColors ? window.ChartColors.getThemeColors().warning : '#f59e0b';
        },
        get danger() {
            return window.ChartColors ? window.ChartColors.getThemeColors().danger : '#ef4444';
        },
        get unsorted() {
            return window.ChartColors ? window.ChartColors.getThemeColors().unsorted : '#6c757d';
        }
    },
    chartOptions: {
        animation: { duration: 1500, easing: 'easeInOutQuart' },
        responsive: true,
        maintainAspectRatio: false,
        layout: {
            padding: {
                top: 20,
                right: 20,
                bottom: 30, // Extra space for bottom legends
                left: 20
            },
            autoPadding: true // Let Chart.js calculate padding automatically
        },
        plugins: {
            legend: {
                labels: {
                    font: {
                        size: 14,
                        weight: '500'
                    },
                    padding: 15,
                    boxWidth: 16,
                    usePointStyle: true
                }
            },
            tooltip: {
                padding: 12,
                titleFont: {
                    size: 14,
                    weight: '600'
                },
                bodyFont: {
                    size: 13,
                    weight: '500'
                },
                backgroundColor: 'rgba(0, 0, 0, 0.85)',
                titleColor: window.ChartColors ? window.ChartColors.getThemeColors().textWhite || '#fff' : '#fff',
                bodyColor: window.ChartColors ? window.ChartColors.getThemeColors().textWhite || '#fff' : '#fff',
                borderColor: window.ChartColors ? window.ChartColors.getThemeColors().primary : '#667eea',
                borderWidth: 2,
                cornerRadius: 8
            }
        },
        scales: {
            x: {
                ticks: {
                    font: {
                        size: 12,
                        weight: '500'
                    },
                    padding: 10
                },
                title: {
                    display: true,
                    font: {
                        size: 14,
                        weight: '600'
                    },
                    padding: {
                        top: 10
                    }
                }
            },
            y: {
                ticks: {
                    font: {
                        size: 12,
                        weight: '500'
                    },
                    padding: 10
                },
                title: {
                    display: true,
                    font: {
                        size: 14,
                        weight: '600'
                    },
                    padding: {
                        bottom: 10
                    }
                }
            }
        }
    },
    filterMappings: {
        files: {
            combined: { category: 'files-filter-category', source: 'files-filter-source', 
                       side: 'files-filter-side', keyword: 'files-filter-keyword' }
        },
        categories: {
            combined: { source: 'categories-filter-source', side: 'categories-filter-side' }
        },
        keywords: {
            combined: { category: 'keywords-filter-category', source: 'keywords-filter-source', 
                       side: 'keywords-filter-side' }
        },
        sources: {
            combined: { filetype: 'sources-filter-filetype', side: 'sources-filter-side', 
                       keyword: 'sources-filter-keyword' }
        },
        sides: {
            combined: { filetype: 'sides-filter-filetype', category: 'sides-filter-category',
                       keyword: 'sides-filter-keyword' }
        },
        words: {
            grid: { category: 'words-filter-category' }
        },
        similar: {
            combined: { threshold: 'similar-filter-threshold', minsize: 'similar-filter-minsize', type: 'similar-filter-type' }
        }
    }
};

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
    initializeTabNavigation();
    loadFilterOptions();
    loadLayout('files');
});

// ===== TAB NAVIGATION =====
function initializeTabNavigation() {
    const tabButtons = document.querySelectorAll('.tab-button');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            const layout = button.getAttribute('data-layout');
            switchLayout(layout);
        });
        
        // Keyboard navigation
        button.addEventListener('keydown', (e) => {
            handleTabKeyboard(e, tabButtons);
        });
    });
}

function handleTabKeyboard(e, tabButtons) {
    const currentIndex = Array.from(tabButtons).indexOf(e.target);
    let newIndex;
    
    switch(e.key) {
        case 'ArrowRight':
            e.preventDefault();
            newIndex = (currentIndex + 1) % tabButtons.length;
            tabButtons[newIndex].focus();
            break;
        case 'ArrowLeft':
            e.preventDefault();
            newIndex = currentIndex - 1;
            if (newIndex < 0) newIndex = tabButtons.length - 1;
            tabButtons[newIndex].focus();
            break;
        case 'Home':
            e.preventDefault();
            tabButtons[0].focus();
            break;
        case 'End':
            e.preventDefault();
            tabButtons[tabButtons.length - 1].focus();
            break;
        case 'Enter':
        case ' ':
            e.preventDefault();
            e.target.click();
            break;
    }
}

function switchLayout(layoutName) {
    // Update tabs
    document.querySelectorAll('.tab-button').forEach(btn => {
        const isActive = btn.getAttribute('data-layout') === layoutName;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-selected', isActive);
        btn.setAttribute('tabindex', isActive ? '0' : '-1');
    });
    
    // Update layouts
    document.querySelectorAll('.layout-content').forEach(layout => {
        layout.classList.remove('active');
    });
    
    const layoutElement = document.getElementById(`layout-${layoutName}`);
    if (layoutElement) {
        layoutElement.classList.add('active');
        state.currentLayout = layoutName;
        
        // Wait for layout to become visible, then update any existing charts
        requestAnimationFrame(() => {
            updateChartsInLayout(layoutElement);
            // Load data for the layout
            loadLayout(layoutName);
        });
    }
}

function updateChartsInLayout(layoutElement) {
    // Wait a bit for layout to be fully visible
    setTimeout(() => {
        // Find all canvas elements in the layout
        const canvases = layoutElement.querySelectorAll('canvas');
        canvases.forEach(canvas => {
            const chartId = canvas.id;
            if (chartId && state.charts[chartId]) {
                // Update chart to ensure it renders properly now that it's visible
                try {
                    // Check if canvas is visible
                    const isVisible = window.getComputedStyle(canvas).display !== 'none' &&
                                    canvas.offsetWidth > 0 && canvas.offsetHeight > 0;
                    if (isVisible) {
                        state.charts[chartId].resize();
                        state.charts[chartId].update('none');
                    }
                } catch (error) {
                    console.warn(`Error updating chart ${chartId}:`, error);
                }
            }
        });
    }, 100);
}

function loadLayout(layoutName) {
    const [section, mode] = parseLayoutName(layoutName);
    
    switch(section) {
        case 'files':
            loadDataForSection('files', mode);
            break;
        case 'categories':
            loadDataForSection('categories', mode);
            break;
        case 'keywords':
            loadDataForSection('keywords', mode);
            break;
        case 'sources':
            loadDataForSection('sources', mode);
            break;
        case 'sides':
            loadDataForSection('sides', mode);
            break;
        case 'words':
            loadDataForSection('words', 'grid');
            break;
        case 'similar':
            loadDataForSection('similar', 'combined');
            break;
    }
}

function parseLayoutName(layoutName) {
    if (layoutName === 'words') return ['words', 'grid'];
    
    // For combined layouts, the layout name is just the section name
    return [layoutName, 'combined'];
}

// ===== FILTER OPTIONS LOADING =====
async function loadFilterOptions() {
    try {
        await Promise.all([
            loadCategories(),
            loadSources(),
            loadSides(),
            loadKeywords(),
            loadFileTypes()
        ]);
    } catch (error) {
        console.error('Error loading filter options:', error);
    }
}

async function loadCategories() {
    const response = await fetch('/api/categories');
    state.filterData.categories = await response.json();
    
    const selects = [
        'files-filter-category', 'files-chart-filter-category',
        'keywords-filter-category', 'keywords-chart-filter-category',
        'words-filter-category', 'sides-filter-category', 'sides-chart-filter-category'
    ];
    selects.forEach(id => populateSelect(id, state.filterData.categories));
}

async function loadSources() {
    const response = await fetch('/api/sources');
    state.filterData.sources = await response.json();
    
    const selects = [
        'files-filter-source', 'files-chart-filter-source',
        'categories-filter-source', 'categories-chart-filter-source',
        'keywords-filter-source', 'keywords-chart-filter-source'
    ];
    selects.forEach(id => populateSelect(id, state.filterData.sources));
}

async function loadSides() {
    const response = await fetch('/api/sides');
    state.filterData.sides = await response.json();
    
    const selects = [
        'files-filter-side', 'files-chart-filter-side',
        'categories-filter-side', 'categories-chart-filter-side',
        'keywords-filter-side', 'keywords-chart-filter-side',
        'sources-filter-side', 'sources-count-filter-side',
        'sources-size-filter-side', 'sources-rate-filter-side'
    ];
    selects.forEach(id => populateSelect(id, state.filterData.sides));
}

async function loadKeywords() {
    try {
        const response = await fetch('/api/keywords?per_page=100&page=1');
        const data = await response.json();
        
        if (data.success && data.keywords) {
            state.filterData.keywords = data.keywords;
            
            const selects = [
                'files-filter-keyword', 'files-chart-filter-keyword',
                'sources-filter-keyword', 'sources-count-filter-keyword',
                'sources-size-filter-keyword', 'sources-rate-filter-keyword',
                'sides-filter-keyword', 'sides-chart-filter-keyword'
            ];
            selects.forEach(id => populateSelect(id, state.filterData.keywords, 'id', 'text'));
        }
    } catch (error) {
        console.error('Error loading keywords:', error);
        state.filterData.keywords = [];
    }
}

async function loadFileTypes() {
    const response = await fetch('/api/analytics/file-type-distribution');
    const data = await response.json();
    
    if (data.types) {
        state.filterData.fileTypes = data.types;
        
        const selects = [
            'sources-filter-filetype', 'sources-count-filter-filetype',
            'sources-size-filter-filetype', 'sources-rate-filter-filetype',
            'sides-filter-filetype', 'sides-chart-filter-filetype'
        ];
        selects.forEach(id => populateSelect(id, state.filterData.fileTypes, 'type', 'type'));
    }
}

function populateSelect(selectId, data, valueKey = 'id', textKey = 'name') {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    const firstOption = select.options[0];
    select.innerHTML = '';
    if (firstOption) select.appendChild(firstOption);
    
    data.forEach(item => {
        const option = document.createElement('option');
        option.value = item[valueKey];
        option.textContent = item[textKey];
        select.appendChild(option);
    });
}

// ===== UNIFIED FILTER & LOAD FUNCTIONS =====
function applyFilters(section, mode) {
    loadDataForSection(section, mode);
}

function resetFilters(section, mode) {
    const filterIds = CONFIG.filterMappings[section][mode];
    Object.values(filterIds).forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
    });
    loadDataForSection(section, mode);
}

function getFilterParams(section, mode) {
    const filterIds = CONFIG.filterMappings[section][mode];
    const params = new URLSearchParams();
    
    Object.entries(filterIds).forEach(([key, id]) => {
        const element = document.getElementById(id);
        if (element && element.value) {
            const paramName = key === 'filetype' ? 'file_type' : 
                            key === 'keyword' ? 'keyword_id' :
                            key === 'category' ? 'category_id' :
                            key === 'source' ? 'source_id' :
                            key === 'side' ? 'side_id' :
                            key === 'threshold' ? 'similarity_threshold' :
                            key === 'minsize' ? 'min_group_size' :
                            key === 'type' ? 'group_type' : key;
            params.append(paramName, element.value);
        }
    });
    
    return params;
}

// ===== DATA LOADING =====
async function loadDataForSection(section, mode) {
    const layoutId = `layout-${section}`;
    const layoutElement = document.getElementById(layoutId);
    
    if (!layoutElement || !layoutElement.classList.contains('active')) {
        return;
    }
    
    const params = getFilterParams(section, mode);
    let apiEndpoint;
    
    if (section === 'words') {
        apiEndpoint = `/api/dashboard/words?${params}`;
    } else if (section === 'similar') {
        apiEndpoint = `/api/dashboard/similar-files?${params}`;
    } else {
        apiEndpoint = `/api/dashboard/${section}-filtered?${params}`;
    }
    
    setLoadingState(section, mode, true);
    
    try {
        const response = await fetch(apiEndpoint);
        const data = await response.json();
        
        if (data.success) {
            renderData(section, mode, data);
        } else {
            showError(section, mode, translations.errorLoadingData);
        }
    } catch (error) {
        console.error(`Error loading ${section} ${mode}:`, error);
        showError(section, mode, error.message);
    } finally {
        setLoadingState(section, mode, false);
    }
}

function setLoadingState(section, mode, isLoading) {
    const resultsElement = document.getElementById(`${section}-results`);
    
    if (resultsElement) {
        resultsElement.setAttribute('aria-busy', isLoading);
        if (isLoading) {
            resultsElement.innerHTML = '<div class="skeleton-loader skeleton-table"></div>';
        }
    }
    
    // Set loading for all count elements
    const countIds = [`${section}-count`, `${section}-chart-count`, 
                      `${section}-count-chart-count`, `${section}-size-chart-count`, 
                      `${section}-rate-chart-count`];
    
    countIds.forEach(countId => {
        const countElement = document.getElementById(countId);
        if (countElement) {
            if (isLoading) {
                countElement.textContent = '...';
            }
        }
    });
    
    // Special handling for similar section
    if (section === 'similar') {
        const countElement = document.getElementById('similar-count');
        if (countElement && isLoading) {
            countElement.textContent = '...';
        }
    }
}

function showError(section, mode, message) {
    let resultsId;
    if (section === 'similar') {
        resultsId = 'similar-results';
    } else {
        resultsId = mode === 'table' ? `${section}-results` : null;
    }
    
    if (resultsId) {
        const resultsElement = document.getElementById(resultsId);
        if (resultsElement) {
            resultsElement.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
                    <p>${translations.errorLoadingData}: ${message}</p>
                </div>
            `;
        }
    }
}

// ===== DATA RENDERING =====
function renderData(section, mode, data) {
    switch(section) {
        case 'files':
            renderFiles(mode, data);
            break;
        case 'categories':
            renderCategories(mode, data);
            break;
        case 'keywords':
            renderKeywords(mode, data);
            break;
        case 'sources':
            renderSources(mode, data);
            break;
        case 'sides':
            renderSides(mode, data);
            break;
        case 'words':
            renderWords(data);
            break;
        case 'similar':
            renderSimilar(data);
            break;
    }
}

// ===== FILES RENDERING =====
function renderFiles(mode, data) {
    if (!data.file_types || data.file_types.length === 0) {
        showEmptyState('files', mode, translations.noFileTypesFound);
        return;
    }
    
    // Render table
    document.getElementById('files-count').textContent = `${data.file_types.length} ${translations.fileTypesLabel}`;
    document.getElementById('files-results').innerHTML = createTable(
        [translations.fileType, translations.fileCount, translations.totalSize, translations.avgSize],
        data.file_types.map(ft => [
            `<strong>${ft.type || translations.unknown}</strong>`,
            `<span class="badge-count">${ft.count.toLocaleString()}</span>`,
            formatFileSize(ft.total_size),
            formatFileSize(ft.avg_size)
        ])
    );
    
    // Render chart
    document.getElementById('files-chart-count').textContent = `${data.file_types.length} ${translations.fileTypesLabel}`;
    renderBarChart('files-chart', data.file_types.slice(0, 10), {
        labelKey: 'type',
        valueKey: 'count',
        tooltipCallback: (index) => {
            const type = data.file_types[index];
            return [
                `${translations.files}: ${type.count.toLocaleString()}`,
                `${translations.totalSizeLabel}: ${formatFileSize(type.total_size)}`,
                `${translations.avgSizeLabel}: ${formatFileSize(type.avg_size)}`
            ];
        }
    });
}

// ===== CATEGORIES RENDERING =====
function renderCategories(mode, data) {
    if (!data.categories || data.categories.length === 0) {
        showEmptyState('categories', mode, translations.noCategoriesFound);
        return;
    }
    
    // Render table
    document.getElementById('categories-count').textContent = `${data.categories.length} ${translations.categoriesLabel}`;
    document.getElementById('categories-results').innerHTML = createTable(
        [translations.category, translations.fileCount, translations.wordCount, translations.fileDensity],
        data.categories.map(cat => [
            `<strong>${cat.name}</strong>`,
            `<span class="badge-count">${cat.file_count.toLocaleString()}</span>`,
            cat.word_count.toLocaleString(),
            `<span class="badge-density">${cat.file_density.toFixed(2)}</span>`
        ])
    );
    
    // Render chart
    document.getElementById('categories-chart-count').textContent = `${data.categories.length} ${translations.categoriesLabel}`;
    renderBarChart('categories-chart', data.categories.slice(0, 15), {
        labelKey: 'name',
        valueKey: 'file_density',
        tooltipCallback: (index) => {
            const cat = data.categories[index];
            return [
                `${translations.density}: ${cat.file_density.toFixed(2)}`,
                `${translations.files}: ${cat.file_count.toLocaleString()}`,
                `${translations.words}: ${cat.word_count.toLocaleString()}`
            ];
        }
    });
}

// ===== KEYWORDS RENDERING =====
function renderKeywords(mode, data) {
    if (!data.keywords || data.keywords.length === 0) {
        showEmptyState('keywords', mode, translations.noKeywordsFound);
        // Clear chart if no data
        const chartCanvas = document.getElementById('keywords-chart');
        if (chartCanvas && state.charts['keywords-chart']) {
            state.charts['keywords-chart'].destroy();
            delete state.charts['keywords-chart'];
        }
        return;
    }
    
    // Filter out invalid keywords (missing required fields)
    const validKeywords = data.keywords.filter(kw => 
        kw && (kw.text !== undefined && kw.text !== null) && 
        (kw.file_density !== undefined && kw.file_density !== null)
    );
    
    if (validKeywords.length === 0) {
        showEmptyState('keywords', mode, translations.noKeywordsFound);
        const chartCanvas = document.getElementById('keywords-chart');
        if (chartCanvas && state.charts['keywords-chart']) {
            state.charts['keywords-chart'].destroy();
            delete state.charts['keywords-chart'];
        }
        return;
    }
    
    // Render table
    document.getElementById('keywords-count').textContent = `${validKeywords.length} ${translations.keywordsLabel}`;
    document.getElementById('keywords-results').innerHTML = createTable(
        [translations.keyword, translations.fileCount, translations.wordCount, translations.fileDensity],
        validKeywords.map(kw => [
            `<strong>${kw.text || translations.unknown}</strong>`,
            `<span class="badge-count">${(kw.file_count || 0).toLocaleString()}</span>`,
            (kw.word_count || 0).toLocaleString(),
            `<span class="badge-density">${(kw.file_density || 0).toFixed(2)}</span>`
        ])
    );
    
    // Render chart - ensure we have valid data
    const chartData = validKeywords.slice(0, 15);
    if (chartData.length > 0) {
        document.getElementById('keywords-chart-count').textContent = `${validKeywords.length} ${translations.keywordsLabel}`;
        
        // Check if all file_density values are zero - if so, use file_count instead
        const allDensityZero = chartData.every(kw => !kw.file_density || kw.file_density === 0);
        const valueKey = allDensityZero ? 'file_count' : 'file_density';
        
        // Sort by the value we're using for better visualization
        const sortedData = [...chartData].sort((a, b) => {
            const valA = allDensityZero ? (a.file_count || 0) : (a.file_density || 0);
            const valB = allDensityZero ? (b.file_count || 0) : (b.file_density || 0);
            return valB - valA;
        });
        
        renderBarChart('keywords-chart', sortedData, {
            labelKey: 'text',
            valueKey: valueKey,
            maxLabelLength: 25,
            tooltipCallback: (index) => {
                const kw = sortedData[index];
                if (!kw) return [];
                return [
                    `${translations.keyword}: ${kw.text || translations.unknown}`,
                    `${translations.density}: ${(kw.file_density || 0).toFixed(2)}`,
                    `${translations.files}: ${(kw.file_count || 0).toLocaleString()}`,
                    `${translations.words}: ${(kw.word_count || 0).toLocaleString()}`
                ];
            }
        });
    } else {
        // Clear chart if no valid data
        const chartCanvas = document.getElementById('keywords-chart');
        if (chartCanvas && state.charts['keywords-chart']) {
            state.charts['keywords-chart'].destroy();
            delete state.charts['keywords-chart'];
        }
    }
}

// ===== SOURCES RENDERING =====
function renderSources(mode, data) {
    if (!data.sources || data.sources.length === 0) {
        showEmptyState('sources', mode, translations.noSourcesFound);
        return;
    }
    
    // Render table
    document.getElementById('sources-count').textContent = `${data.sources.length} ${translations.sourcesLabel}`;
    document.getElementById('sources-results').innerHTML = createTable(
        [translations.sourceName, translations.fileCount, translations.totalSize, translations.avgSize, translations.fileTypes, translations.processed, translations.processingRate],
        data.sources.map(src => [
            `<strong>${src.name}</strong>`,
            `<span class="badge-count">${src.file_count.toLocaleString()}</span>`,
            formatFileSize(src.total_size),
            formatFileSize(src.avg_size),
            src.unique_file_types,
            src.processed_files.toLocaleString(),
            `${src.processing_rate.toFixed(1)}%`
        ])
    );
    
    // Render file count chart
    document.getElementById('sources-count-chart-count').textContent = `${data.sources.length} ${translations.sourcesLabel}`;
    renderBarChart('sources-chart-count', data.sources.slice(0, 15), {
        labelKey: 'name',
        valueKey: 'file_count',
        tooltipCallback: (index) => {
            const src = data.sources[index];
            return [
                `${translations.files}: ${src.file_count.toLocaleString()}`,
                `${translations.totalSizeLabel}: ${formatFileSize(src.total_size)}`,
                `${translations.processingRateLabel}: ${src.processing_rate.toFixed(1)}%`
            ];
        }
    });
    
    // Render size chart
    document.getElementById('sources-size-chart-count').textContent = `${data.sources.length} ${translations.sourcesLabel}`;
    renderDoughnutChart('sources-chart-size', data.sources.slice(0, 10), {
        labelKey: 'name',
        valueKey: 'total_size',
        tooltipCallback: (index) => {
            const src = data.sources[index];
            return [
                `${translations.source}: ${src.name}`,
                `${translations.totalSizeLabel}: ${formatFileSize(src.total_size)}`,
                `${translations.files}: ${src.file_count.toLocaleString()}`
            ];
        }
    });
    
    // Render processing rate chart
    document.getElementById('sources-rate-chart-count').textContent = `${data.sources.length} ${translations.sourcesLabel}`;
    const sources = data.sources.slice(0, 15);
    const colors = sources.map(s => 
        s.processing_rate >= 90 ? CONFIG.colors.success :
        s.processing_rate >= 70 ? CONFIG.colors.warning : CONFIG.colors.danger
    );
    renderBarChart('sources-chart-rate', sources, {
        labelKey: 'name',
        valueKey: 'processing_rate',
        customColors: colors,
        yMax: 100,
        yTicksSuffix: '%',
        tooltipCallback: (index) => {
            const src = sources[index];
            return [
                `${translations.processingRateLabel}: ${src.processing_rate.toFixed(1)}%`,
                `${translations.processed}: ${src.processed_files.toLocaleString()} / ${src.file_count.toLocaleString()}`,
                `${translations.totalFiles}: ${src.file_count.toLocaleString()}`
            ];
        }
    });
}

// ===== SIDES RENDERING =====
function renderSides(mode, data) {
    if (!data.sides || data.sides.length === 0) {
        showEmptyState('sides', mode, translations.noSidesFound);
        return;
    }
    
    // Render table
    document.getElementById('sides-count').textContent = `${data.sides.length} ${translations.sidesLabel}`;
    document.getElementById('sides-results').innerHTML = createTable(
        [translations.sideName, translations.importance, translations.fileCount, translations.totalSize, translations.avgSize, translations.fileTypes, translations.sources, translations.processed, translations.processingRate],
        data.sides.map(side => [
            `<strong>${side.name}</strong>`,
            `<span class="badge-count">${side.importance}</span>`,
            `<span class="badge-count">${side.file_count.toLocaleString()}</span>`,
            formatFileSize(side.total_size),
            formatFileSize(side.avg_size),
            side.unique_file_types,
            side.source_count.toLocaleString(),
            side.processed_files.toLocaleString(),
            `${side.processing_rate.toFixed(1)}%`
        ])
    );
    
    // Render chart
    document.getElementById('sides-chart-count').textContent = `${data.sides.length} ${translations.sidesLabel}`;
    renderBarChart('sides-chart', data.sides.slice(0, 15), {
        labelKey: 'name',
        valueKey: 'file_count',
        tooltipCallback: (index) => {
            const side = data.sides[index];
            return [
                `${translations.side}: ${side.name}`,
                `${translations.importance}: ${side.importance}`,
                `${translations.files}: ${side.file_count.toLocaleString()}`,
                `${translations.totalSizeLabel}: ${formatFileSize(side.total_size)}`,
                `${translations.avgSizeLabel}: ${formatFileSize(side.avg_size)}`,
                `${translations.fileTypesLabel2}: ${side.unique_file_types}`,
                `${translations.sources}: ${side.source_count.toLocaleString()}`,
                `${translations.processed}: ${side.processed_files.toLocaleString()} / ${side.file_count.toLocaleString()}`,
                `${translations.processingRateLabel}: ${side.processing_rate.toFixed(1)}%`
            ];
        }
    });
}

// ===== WORDS RENDERING =====
function renderWords(data) {
    if (!data.words || data.words.length === 0) {
        showEmptyState('words', 'grid', translations.noWordsFound);
        return;
    }
    
    if (state.wordsViewMode === 'grid') {
        const wordsGrid = data.words.map(word => 
            `<div class="word-item">
                <div class="word-text">${word.word || word.text || translations.unknown}</div>
                <div class="word-count">${word.file_count || 0} ${translations.filesLabel}</div>
                ${word.category ? `<div class="word-category">${word.category}</div>` : ''}
            </div>`
        ).join('');
        
        document.getElementById('words-results').innerHTML = `
            <div class="words-grid">
                ${wordsGrid}
            </div>
        `;
    } else {
        document.getElementById('words-results').innerHTML = '';
        document.getElementById('words-chart-container').style.display = 'block';
        renderBarChart('words-chart', data.words.slice(0, 20), {
            labelKey: 'word',
            valueKey: 'file_count',
            tooltipCallback: (index) => {
                const word = data.words[index];
                return [`${translations.word}: ${word.word}`, `${translations.files}: ${word.file_count.toLocaleString()}`];
            }
        });
    }
}

function toggleWordsView() {
    state.wordsViewMode = state.wordsViewMode === 'grid' ? 'chart' : 'grid';
    const toggleText = document.getElementById('view-toggle-text');
    const icon = document.querySelector('#toggle-words-view i');
    
    if (state.wordsViewMode === 'chart') {
        toggleText.textContent = translations.gridView;
        icon.className = 'bi bi-grid-3x3-gap';
        document.getElementById('words-results').style.display = 'none';
        document.getElementById('words-chart-container').style.display = 'block';
    } else {
        toggleText.textContent = translations.chartView;
        icon.className = 'bi bi-graph-up';
        document.getElementById('words-results').style.display = 'block';
        document.getElementById('words-chart-container').style.display = 'none';
    }
    
    loadDataForSection('words', 'grid');
}

// ===== SIMILAR FILES RENDERING =====
function renderSimilar(data) {
    if (!data || (!data.hash_groups && !data.title_groups)) {
        showEmptyState('similar', 'combined', translations.noSimilarFilesFound || 'No similar files found');
        return;
    }
    
    const filterType = document.getElementById('similar-filter-type')?.value || '';
    let allGroups = [];
    
    // Add hash groups
    if (data.hash_groups && (!filterType || filterType === 'hash')) {
        allGroups = allGroups.concat(data.hash_groups);
    }
    
    // Add title groups
    if (data.title_groups && (!filterType || filterType === 'title')) {
        allGroups = allGroups.concat(data.title_groups);
    }
    
    if (allGroups.length === 0) {
        showEmptyState('similar', 'combined', translations.noSimilarFilesFound || 'No similar files found');
        return;
    }
    
    // Update count
    const totalGroups = allGroups.length;
    const totalFiles = allGroups.reduce((sum, g) => sum + g.count, 0);
    document.getElementById('similar-count').textContent = `${totalGroups} ${translations.groupsLabel || 'groups'} (${totalFiles} ${translations.filesLabel})`;
    
    // Render groups
    const groupsHtml = allGroups.map(group => {
        const groupTypeLabel = group.group_type === 'hash' 
            ? `<span class="badge badge-hash"><i class="bi bi-hash"></i> ${translations.hashDuplicate || 'Hash Duplicate'}</span>`
            : `<span class="badge badge-title"><i class="bi bi-file-text"></i> ${translations.similarTitle || 'Similar Title'}</span>`;
        
        const groupHeader = group.group_type === 'hash'
            ? `<div class="similar-group-header">
                <div class="similar-group-title">
                    ${groupTypeLabel}
                    <span class="similar-group-count">${group.count} ${translations.filesLabel}</span>
                </div>
                <div class="similar-group-hash">
                    <code>${group.hash ? group.hash.substring(0, 16) + '...' : ''}</code>
                </div>
            </div>`
            : `<div class="similar-group-header">
                <div class="similar-group-title">
                    ${groupTypeLabel}
                    <span class="similar-group-count">${group.count} ${translations.filesLabel}</span>
                    ${group.is_identical ? '<span class="badge badge-identical"><i class="bi bi-check-circle"></i> Identical</span>' : ''}
                </div>
                <div class="similar-group-title-text">"${escapeHtml(group.representative_title || '')}"</div>
            </div>`;
        
        const filesTable = createTable(
            [translations.fileName || 'File Name', translations.fileType || 'Type', translations.fileSize || 'Size', translations.source || 'Source', translations.side || 'Side'],
            group.files.map(file => [
                `<strong>${escapeHtml(file.file_name || file.title || translations.unknown)}</strong>`,
                file.file_type || '-',
                formatFileSize(file.file_size || 0),
                file.source_name || '-',
                file.side_name || '-'
            ])
        );
        
        return `
            <div class="similar-group">
                ${groupHeader}
                ${filesTable}
            </div>
        `;
    }).join('');
    
    document.getElementById('similar-results').innerHTML = `
        <div class="similar-groups-container">
            ${groupsHtml}
        </div>
    `;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ===== CHART HELPERS =====
function renderBarChart(canvasId, data, options = {}) {
    const {
        labelKey = 'name',
        valueKey = 'value',
        customColors = null,
        yMax = null,
        yTicksSuffix = '',
        maxLabelLength = 20,
        tooltipCallback = null
    } = options;
    
    if (state.charts[canvasId]) {
        state.charts[canvasId].destroy();
        delete state.charts[canvasId];
    }
    
    const ctx = document.getElementById(canvasId);
    if (!ctx) {
        console.warn(`Canvas element with id '${canvasId}' not found`);
        return;
    }
    
    // Check if data is empty
    if (!data || data.length === 0) {
        showEmptyChartState(canvasId, translations.noDataAvailable);
        return;
    }
    
    // Ensure canvas is visible (restore if it was hidden by empty state)
    ctx.style.display = '';
    
    // Remove any empty state messages from the container
    const chartContainer = ctx.closest('.chart-container-layout, .chart-container');
    if (chartContainer) {
        const emptyStates = chartContainer.querySelectorAll('.empty-state');
        emptyStates.forEach(state => state.remove());
    }
    
    const isVisible = chartContainer && 
                     window.getComputedStyle(chartContainer).display !== 'none' &&
                     window.getComputedStyle(ctx).display !== 'none';
    
    // If not visible, wait for it to become visible
    if (!isVisible) {
        // Use requestAnimationFrame to wait for next render cycle
        requestAnimationFrame(() => {
            renderBarChart(canvasId, data, options);
        });
        return;
    }
    
    // Ensure canvas has dimensions
    if (ctx.offsetWidth === 0 || ctx.offsetHeight === 0) {
        // Wait a bit for layout to settle
        setTimeout(() => {
            renderBarChart(canvasId, data, options);
        }, 100);
        return;
    }
    
    const labels = data.map(item => truncateLabel(item[labelKey], maxLabelLength));
    // Ensure values are numbers and handle null/undefined
    const values = data.map(item => {
        const val = item[valueKey];
        if (val === null || val === undefined || val === '') return 0;
        const numVal = typeof val === 'string' ? parseFloat(val) : Number(val);
        return isNaN(numVal) ? 0 : numVal;
    });
    const colors = customColors || CONFIG.colors.primary.slice(0, data.length);
    
    // Debug logging for keywords chart
    if (canvasId === 'keywords-chart') {
        console.log('Keywords chart data:', {
            labels: labels.slice(0, 5),
            values: values.slice(0, 5),
            dataLength: data.length,
            valueKey: valueKey
        });
    }
    
    // Check if all values are zero - if so, log a warning
    const maxValue = Math.max(...values);
    if (maxValue === 0 && values.length > 0) {
        console.warn(`All values are zero for chart ${canvasId}. Chart may not display bars.`);
    }
    
    try {
        state.charts[canvasId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: valueKey.replace(/_/g, ' ').toUpperCase(),
                    data: values,
                    backgroundColor: colors,
                    borderWidth: 0,
                    borderRadius: 8
                }]
            },
            options: {
                ...CONFIG.chartOptions,
                scales: {
                    x: {
                        ...CONFIG.chartOptions.scales?.x,
                        ticks: {
                            ...CONFIG.chartOptions.scales?.x?.ticks,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            padding: 10
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: yMax,
                        ticks: {
                            ...CONFIG.chartOptions.scales?.y?.ticks,
                            callback: (value) => value + yTicksSuffix,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            padding: 10
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        ...CONFIG.chartOptions.plugins.tooltip,
                        callbacks: {
                            label: (context) => {
                                if (tooltipCallback) {
                                    return tooltipCallback(context.dataIndex);
                                }
                                return `${context.label}: ${context.parsed.y}${yTicksSuffix}`;
                            }
                        }
                    },
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // Force chart to render properly
        // Use multiple update strategies to ensure rendering
        requestAnimationFrame(() => {
            if (state.charts[canvasId]) {
                try {
                    state.charts[canvasId].resize();
                    state.charts[canvasId].update('none');
                } catch (e) {
                    console.warn(`Error updating chart ${canvasId}:`, e);
                }
            }
        });
        
        // Also update after a short delay to catch any layout changes
        setTimeout(() => {
            if (state.charts[canvasId]) {
                try {
                    state.charts[canvasId].resize();
                    state.charts[canvasId].update('none');
                } catch (e) {
                    console.warn(`Error updating chart ${canvasId} (delayed):`, e);
                }
            }
        }, 200);
        
        // Attach export buttons
        if (window.ChartExport) {
            if (chartContainer) {
                setTimeout(() => {
                    window.ChartExport.attachExportButtonsToCharts(chartContainer);
                }, 100);
            }
        }
    } catch (error) {
        console.error(`Error creating chart for ${canvasId}:`, error);
    }
}

function renderDoughnutChart(canvasId, data, options = {}) {
    const {
        labelKey = 'name',
        valueKey = 'value',
        tooltipCallback = null
    } = options;
    
    if (state.charts[canvasId]) {
        state.charts[canvasId].destroy();
        delete state.charts[canvasId];
    }
    
    const ctx = document.getElementById(canvasId);
    if (!ctx) {
        console.warn(`Canvas element with id '${canvasId}' not found`);
        return;
    }
    
    // Check if data is empty
    if (!data || data.length === 0) {
        showEmptyChartState(canvasId, translations.noDataAvailable);
        return;
    }
    
    // Ensure canvas is visible (restore if it was hidden by empty state)
    ctx.style.display = '';
    
    // Remove any empty state messages from the container
    const chartContainer = ctx.closest('.chart-container-layout, .chart-container');
    if (chartContainer) {
        const emptyStates = chartContainer.querySelectorAll('.empty-state');
        emptyStates.forEach(state => state.remove());
    }
    
    const isVisible = chartContainer && 
                     window.getComputedStyle(chartContainer).display !== 'none' &&
                     window.getComputedStyle(ctx).display !== 'none';
    
    // If not visible, wait for it to become visible
    if (!isVisible) {
        requestAnimationFrame(() => {
            renderDoughnutChart(canvasId, data, options);
        });
        return;
    }
    
    // Ensure canvas has dimensions
    if (ctx.offsetWidth === 0 || ctx.offsetHeight === 0) {
        setTimeout(() => {
            renderDoughnutChart(canvasId, data, options);
        }, 100);
        return;
    }
    
    const labels = data.map(item => item[labelKey]);
    const values = data.map(item => item[valueKey]);
    
    // Determine legend position from options or default to 'right'
    const legendPosition = options.legendPosition || 'right';
    
    // Set data attribute on container for CSS targeting
    if (chartContainer) {
        chartContainer.setAttribute('data-legend-position', legendPosition);
    }
    
    try {
        state.charts[canvasId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: CONFIG.colors.primary,
                    borderWidth: 2,
                    borderColor: window.ChartColors ? window.ChartColors.getThemeColors().textWhite || '#fff' : '#fff'
                }]
            },
            options: {
                ...CONFIG.chartOptions,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                if (tooltipCallback) {
                                    return tooltipCallback(context.dataIndex);
                                }
                                return `${context.label}: ${context.parsed}`;
                            }
                        }
                    },
                    legend: {
                        display: true,
                        position: legendPosition,
                        labels: {
                            font: {
                                size: 14,
                                weight: '500'
                            },
                            padding: 15,
                            boxWidth: 16,
                            usePointStyle: true,
                            maxWidth: legendPosition === 'right' ? 250 : undefined // Limit legend width for right position
                        }
                    }
                }
            }
        });
        
        // Update chart after a short delay to ensure proper rendering
        setTimeout(() => {
            if (state.charts[canvasId]) {
                state.charts[canvasId].update('none');
                // After update, check if legend position changed and update container attribute
                const actualLegendPosition = state.charts[canvasId].options.plugins.legend.position;
                if (chartContainer && actualLegendPosition) {
                    chartContainer.setAttribute('data-legend-position', actualLegendPosition);
                }
            }
        }, 50);
        
        // Attach export buttons
        if (window.ChartExport && chartContainer) {
            setTimeout(() => {
                window.ChartExport.attachExportButtonsToCharts(chartContainer);
            }, 100);
        }
    } catch (error) {
        console.error(`Error creating chart for ${canvasId}:`, error);
    }
}

// ===== UTILITY FUNCTIONS =====
function createTable(headers, rows) {
    // If no rows, show empty state
    if (!rows || rows.length === 0) {
        return `
            <div class="empty-state">
                <i class="bi bi-inbox" aria-hidden="true"></i>
                <p>${translations.noDataAvailable}</p>
            </div>
        `;
    }
    
    const headerRow = headers.map(h => `<th>${h}</th>`).join('');
    const bodyRows = rows.map(row => 
        `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`
    ).join('');
    
    return `
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>${headerRow}</tr>
                </thead>
                <tbody>
                    ${bodyRows}
                </tbody>
            </table>
        </div>
    `;
}

function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
}

function truncateLabel(label, maxLength) {
    if (!label) return translations.unknown;
    return label.length > maxLength ? label.substring(0, maxLength) + '...' : label;
}

function showEmptyState(section, mode, message) {
    let resultsId;
    let countId;
    let chartId;
    
    if (section === 'similar') {
        resultsId = 'similar-results';
        countId = 'similar-count';
    } else {
        // For combined mode, we still need to show empty state in the results container
        // The results container exists for all sections regardless of mode
        resultsId = `${section}-results`;
        // Count ID is always just section-count for combined mode
        countId = `${section}-count`;
        
        // For combined views, also handle chart containers
        if (mode === 'combined') {
            // Map section to chart ID
            const chartIdMap = {
                'files': 'files-chart',
                'categories': 'categories-chart',
                'keywords': 'keywords-chart',
                'sources': ['sources-chart-count', 'sources-chart-size', 'sources-chart-rate'],
                'sides': 'sides-chart'
            };
            chartId = chartIdMap[section];
        } else if (section === 'words' && mode === 'grid') {
            // Words section has a chart that might be visible
            chartId = 'words-chart';
        }
    }
    
    // Show empty state in table/results container
    if (resultsId) {
        const resultsElement = document.getElementById(resultsId);
        if (resultsElement) {
            resultsElement.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-inbox" aria-hidden="true"></i>
                    <p>${message}</p>
                </div>
            `;
        }
    }
    
    // Show empty state in chart container(s)
    if (chartId) {
        if (Array.isArray(chartId)) {
            // Handle multiple charts (like sources)
            chartId.forEach(id => showEmptyChartState(id, message));
        } else {
            showEmptyChartState(chartId, message);
        }
    }
    
    // Update count
    const countElement = document.getElementById(countId);
    if (countElement) {
        countElement.textContent = `0 ${translations.itemsLabel || 'items'}`;
    }
}

function showEmptyChartState(canvasId, message) {
    // Destroy existing chart if it exists
    if (state.charts[canvasId]) {
        try {
            state.charts[canvasId].destroy();
        } catch (e) {
            console.warn(`Error destroying chart ${canvasId}:`, e);
        }
        delete state.charts[canvasId];
    }
    
    // Find the canvas and its container
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const chartContainer = canvas.closest('.chart-container-layout, .chart-container');
    if (!chartContainer) return;
    
    // Check if empty state already exists
    const existingEmptyState = chartContainer.querySelector('.empty-state');
    if (existingEmptyState) {
        // Update the message
        const messageElement = existingEmptyState.querySelector('p');
        if (messageElement) {
            messageElement.textContent = message || translations.noDataAvailable;
        }
        return;
    }
    
    // Hide canvas
    canvas.style.display = 'none';
    
    // Create and add empty state message
    const emptyStateDiv = document.createElement('div');
    emptyStateDiv.className = 'empty-state';
    emptyStateDiv.style.cssText = 'display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 500px; padding: 2rem;';
    emptyStateDiv.innerHTML = `
        <i class="bi bi-inbox" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;" aria-hidden="true"></i>
        <p style="color: var(--text-light); font-size: 1.1rem; margin: 0;">${message || translations.noDataAvailable}</p>
    `;
    
    chartContainer.appendChild(emptyStateDiv);
}
</script>
{% endblock %}